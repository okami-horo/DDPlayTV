# Feature Specification: 可插拔字幕渲染后端（新增行业通用渲染后端）

**Feature Branch**: `001-add-libass-backend`  
**Created**: 2025-11-15  
**Status**: Draft  
**Input**: User description: "任务概述 - 目标：在现有 player_component 内并行接入 libass 渲染后端（0.17.3 预编译 .so,已经下载并导入到player_component/libs中了），提供可插拔切换机制 - 背景：自研 Canvas/TextPaint 路线补齐成本与长尾特性风险高；libass 为行业通用方案，兼容性与效果更稳定。 - 成果：旧实现与 libass 并存，可在设置中一键切换与回退。use exa 可以获取libass的文档，libass接入方法参考，代码参考等信息"

## Clarifications

### Session 2025-11-15

- Q: 是否存在“远程配置”开关以控制渲染后端？ → A: 不存在。本版本仅通过“本地设置”进行控制；相关远程配置内容移出本规格（可作为未来扩展）。
- Q: 默认后端选择策略（新安装/升级）？ → A: 旧实现默认（新装与升级均为旧实现）。
- Q: 是否按字幕格式自动路由到不同后端？ → A: 否，始终遵循用户设置；未设置时按 FR-007 默认值。
- Q: 所选后端不支持当前字幕格式时如何处理？ → A: 弹出提示让用户决定是否切换，默认不变更设置且继续播放。
- Q: 回退触发后的处理方式（是否自动回退）？ → A: 阻断式弹窗提示用户切回旧后端；不自动回退，用户确认后立即切换。
- Q: 本次版本需支持哪些播放器内核？ → A: 仅 ExoPlayer（本次版本范围）。
- Q: libass 的字体来源与回退策略？ → A: 字幕目录优先，其次系统字体。
- Q: libass 与视频画面的合成与叠加方式？ → A: TextureView + 自定义叠加 View（Canvas 绘制 Bitmap）。
- Q: SurfaceView 路径是否同样启用 libass？ → A: 是，采用双 Surface 叠加（透明字幕 SurfaceView 覆盖）。
- Q: libass 渲染分辨率基准选择？ → A: 跟随实际显示区域像素大小渲染。
- Q: ASS 样式优先级（与用户自定义样式冲突时）？ → A: 优先保留 ASS 原样式，仅应用偏移类控制。

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 在设置中切换字幕渲染后端（Priority: P1）

作为用户，我希望在应用“设置-播放/字幕”中选择字幕渲染后端（自定义渲染后端〈Canvas/TextPaint〉/libass 渲染后端），以便在遇到兼容性或性能问题时可以快速切换并回退。

**Why this priority**: 直接影响播放体验与兼容性，提供立刻可见的用户价值与自助问题缓解手段。

**Independent Test**: 通过仅修改设置项并重新开始一次播放即可验证：字幕呈现、时序、遮挡/层级与样式是否符合预期。

**Acceptance Scenarios**:

1. Given 用户在设置页选择“libass 渲染后端”，When 退出设置并开始播放一段带 ASS/SSA 字幕的视频，Then 播放中的字幕呈现稳定、位置与时序正确、样式一致。
2. Given 用户再次将设置切换回“自定义渲染后端（Canvas/TextPaint）”，When 重新开始播放同一视频，Then 字幕渲染恢复为旧行为且可正常观看。
3. Given 用户选择“libass 渲染后端”，When 当前字幕格式不受该后端支持，Then 弹出提示询问是否切换到“自定义渲染后端”，默认不变更设置且继续播放。

---

### User Story 2 - 渲染失败提示与手动切换（Priority: P2）

作为用户，当选择的渲染后端无法正确初始化或在播放中出现错误时，我希望系统以阻断式弹窗明确提示，并提供“一键切回旧后端”的操作，而不是静默自动回退，以保证问题可见、便于排查且不打断媒体播放。

**Why this priority**: 降低播放中断风险，提升容错性与用户信任。

**Independent Test**: 通过构造异常字幕样本或模拟初始化失败，验证阻断式弹窗出现、用户确认后立即切回旧后端并恢复字幕显示；用户取消时播放不中断但保留当前后端。

**Acceptance Scenarios**:

1. Given 当前会话选择为 libass 渲染后端，When 初始化失败或运行期首次渲染错误，Then 弹出阻断式对话框，提供“切回自定义渲染后端/继续尝试”选项；用户选择切回时立即切换并恢复字幕显示。
2. Given 弹窗已出现且用户选择“继续尝试”，When 播放继续，Then 媒体播放不中断，当前后端保持不变；用户可稍后在设置页手动切换。

---

### User Story 3 - 调试可观测性（Priority: P3）

作为用户或支持人员，我希望能在“关于/调试信息”中看到当前会话使用的字幕渲染后端与最近一次回退原因（如有），以便在反馈问题时提供准确信息。

**Why this priority**: 降低定位成本，提升问题处理效率。

**Independent Test**: 开启/切换渲染后端并触发一次回退后，进入调试信息页面可见对应字段与最近一次回退记录。

**Acceptance Scenarios**:

1. Given 已选择 libass 渲染后端并正常播放，When 查看调试信息页面，Then 可见“渲染后端：libass（来源：本地设置）”。
2. Given 播放中触发自动回退，When 再次查看调试信息页面，Then 可见“最近一次回退原因：初始化失败/持续渲染错误”。

---

### Edge Cases

- 字体缺失或字体回退导致的排版差异（多语言、双向/合字/竖排场景）。
- 字幕文件包含复杂样式/特效（卡拉 OK、逐字动画、旋转/描边/阴影），渲染质量与性能波动。
- 字幕时间轴异常（重叠密集弹幕、极短帧间隔、跨分辨率比例缩放）。
- 无法解析或损坏的字幕文件；外挂/内封字幕切换；无字幕时的无害行为。
- 播放中切换设置的生效时机；弱网或本地 CPU 压力下的降级表现。
- 选定后端不支持当前字幕格式时的处理方式（提示/回退/忽略）。
  - 处理策略：提示用户决定是否切换，默认不自动回退；用户拒绝则该字幕不渲染但播放不中断。
 - 多 Surface 透明叠加兼容性：少量机型可能出现异常；统一按 FR-004 处理。

### Functional Acceptance（FR-010 ~ FR-015）

- FR-010（仅 Exo 路径启用 libass）
  1. Given 播放器内核选择为 ExoPlayer 且设置为“libass 渲染后端”，When 播放带 ASS/SSA 样式的样本，Then 调试信息显示“渲染后端：libass（来源：本地设置）”，字幕呈现符合 FR-005 要求。
  2. Given 播放器内核切换为 IJK 或 VLC 且设置仍为“libass 渲染后端”，When 播放同一视频，Then 走旧字幕实现（非 libass），调试信息可见“渲染后端：自定义渲染后端/旧实现”，播放与字幕均正常无崩溃。

- FR-011（字体查找顺序）
  1. Given 字幕目录放置与 ASS 引用一致的字体文件（如字体名匹配 `FontName`），When 播放，Then 呈现使用目录字体（观测到特定字形/连字/粗细效果），无额外配置；移除该字体后再次播放，使用系统字体渲染且不中断。
  2. Given 未在字幕目录提供字体引用，When 播放，Then 直接使用系统字体完成渲染，内容可读且无崩溃。

- FR-012（合成路径：TextureView / SurfaceView）
  1. Given `SurfaceType` 为 TextureView 且选择“libass 渲染后端”，When 播放，Then 可见 libass 字幕叠加于视频之上，现有控制层/手势/点击区域行为不受影响。
  2. Given `SurfaceType` 为 SurfaceView 且选择“libass 渲染后端”，When 播放，Then 通过透明字幕 SurfaceView 正常叠加字幕，视频与控制层交互正常无遮挡/黑底。

- FR-013（渲染分辨率基准）
  1. Given 分别以 720p 与 1080p 视频全屏播放，When 启用 libass，Then 字幕相对屏幕的视觉尺寸与定位保持一致（主观评分差异 ≤10%），无明显像素化/模糊。
  2. Given 发生屏幕旋转/分屏/窗口大小变化，When 继续观看，Then 字幕在 500ms 内适配到新的可见区域，边界不裁切、定位正确。

- FR-014（样式优先级）
  1. Given 启用 libass，When 在“字幕样式设置”修改文字大小/颜色/描边/阴影，Then 对渲染结果无影响；修改“时间偏移/垂直偏移”时立即生效（或于下一帧/下一次查找生效），播放不中断。
  2. Given 启用 libass，When 进入“字幕样式设置”，Then 与样式覆盖相关的 UI 项被隐藏或置灰，且不会影响渲染结果。

- FR-015（SurfaceView 叠加实现细则）
  1. Given `SurfaceType` 为 SurfaceView 且启用 libass，When 频繁出现字幕内容变化（如卡拉 OK），Then 字幕无明显拖影；抓帧观察可见每帧已清屏重绘。
  2. Given `SurfaceType` 为 SurfaceView 且启用 libass，When 发生旋转/分屏/窗口大小变化，Then 字幕在 500ms 内适配新的可见区域，定位与对齐正确。
  3. Given 某设备出现透明混合异常（黑底/遮挡），When 首次渲染出错，Then 触发 FR-004 阻断提示：允许用户切回旧后端或改用 TextureView；用户选择后对应效果立即生效。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 提供“字幕渲染后端”设置项，包含“自定义渲染后端（Canvas/TextPaint）”“libass 渲染后端”两个选项；变更对“新开启的播放会话”生效，无需重启应用。
- **FR-003**: 播放会话启动时，根据“本地设置”（未设置时遵循 FR-007 的默认值）确定本次会话实际启用的渲染后端，并在会话范围内保持一致性。
- **FR-004**: 当所选后端初始化失败或运行期首次渲染错误时，显示阻断式对话框，提供“切回自定义渲染后端/继续尝试”选项；用户确认切回时立即切换并重启字幕渲染；用户选择继续则保持当前后端并不中断媒体播放。全程记录一次性用户可见提示与原因，并产生日志/错误事件。
- **FR-005**: 渲染输出需在“位置、时序、层级（遮挡）与样式”上与字幕内容一致；对于无法严格匹配的长尾特性，需记录并可回退。
- **FR-006**: 提供状态可观测性：在“关于/调试信息”中展示当前会话使用的渲染后端与最近一次回退原因（如有），并产生日志/错误事件以便问题追踪（不包含敏感内容）。
- **FR-007**: 默认后端选择策略：新安装与升级均默认“自定义渲染后端（Canvas/TextPaint）”；用户可在设置中手动切换，变更对“新播放会话”生效。
- **FR-008**: 当所选后端不支持当前字幕格式时，向用户弹出提示以选择是否切换到另一后端；默认不变更设置且继续播放（该字幕可不渲染）。
- （删）原“格式路由策略”条款：本版本不按字幕格式自动路由，始终遵循用户设置。
- （移除）原 FR-002、FR-009 与远程配置相关内容。
- **FR-010**: 本次版本的“libass 渲染后端”接入仅在 ExoPlayer 播放内核路径中启用；IJK/VLC 内核路径保持原自定义渲染后端行为，不在本次交付范围。
- **FR-011**: 字体查找顺序（libass）：优先在字幕文件所在目录解析所需字体；未命中时使用系统字体进行渲染。
- **FR-012**: 合成路径（libass）：同时支持 TextureView 与 SurfaceView 两条渲染路径。
  - TextureView：libass 渲染输出为 ARGB 位图，由自定义叠加 View 在 UI 层绘制，与现有控制层共存且不影响交互。
  - SurfaceView：通过额外的字幕专用 SurfaceView 叠加于视频 SurfaceView 之上，采用透明像素格式进行混合并确保正确 Z 序与层级关系。
- **FR-013**: 渲染分辨率基准（libass）：以当前视频“可见显示区域”的实际像素尺寸作为渲染目标尺寸；当显示区域尺寸/旋转/窗口模式发生变化时，重新设置渲染目标尺寸并于下一帧生效，保证不同视频分辨率下视觉一致性。
- **FR-014**: 样式优先级（libass）：优先保留 ASS/SSA 原始样式与特效（包含字体、字号、描边、阴影、定位、对齐、卡拉 OK 等）；仅允许应用“时间偏移、垂直偏移”等通用控制。用户样式自定义项在启用 libass 时不覆盖渲染结果（可隐藏或置灰，行为以不影响渲染为准）。
 - **FR-015**: SurfaceView 叠加实现细则（libass）：
   - 字幕 SurfaceView 使用透明像素格式（如 PixelFormat.TRANSLUCENT），并开启媒体覆盖 Z 序（如 setZOrderMediaOverlay）。
 - 字幕 Surface 的测量/布局与视频可见区域严格对齐；旋转/分屏/窗口变化时同步更新。
 - 仅在字幕内容变化（libass changed 标志为真）或时间游标进入下一事件时重绘；每次绘制前对画布透明清屏，避免拖影。
  - 叠加不影响现有控制层/手势响应；异常统一按 FR-004 处理。

### Key Entities *(include if feature involves data)*

- **RendererPreference**: 用户选择的字幕渲染后端以及最后更新时间；来源（本地设置/默认）。
- **PlaybackSession**: 本次会话渲染后端的最终决策结果、回退标记与原因；与媒体轨道/字幕轨道的绑定关系（不涉及实现细节）。
（移除）RemoteToggle 实体：当前不涉及远程控制。

### Assumptions & Dependencies

- 切换策略以“新播放会话”为边界；当前正在播放的会话不被强制中断。
- 设置变更在“新播放会话开始”时生效，不影响当前会话。
- 字体与排版在不同设备上可能存在轻微差异，测试基于“视觉等效”原则评估。
- 本次版本仅支持 ExoPlayer 播放内核；IJK/VLC 支持暂不纳入范围（后续版本可扩展）。
- 同时覆盖 TextureView 与 SurfaceView：SurfaceView 通过双 Surface 透明叠加实现；少量设备/驱动的透明混合存在差异，异常统一按 FR-004 处理。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 通过包含复杂样式/多语言/高密度场景的标准测试样本集，至少 90% 的样本在 libass 渲染后端下被评为“与参考渲染视觉等效”（QA 双盲评测或对照基线）。
- **SC-002**: 用户可在设置中 10 秒内找到并完成渲染后端切换；切换后首次进入播放的字幕首帧可见时间不劣于现有实现 ±10%。
- **SC-003**: 启用 libass 渲染后端的版本，字幕相关崩溃/严重异常率不高于基线版本（同口径）±10%；出现问题时用户可通过“设置切换”在 1 个应用重启周期内回退恢复（新会话生效）。
- **SC-004**: 在异常触发后 2 秒内出现阻断式提示；用户确认切回后 2 秒内字幕恢复显示且连续性不出现超过 1 处明显断档；若用户选择继续尝试，媒体播放不中断。
