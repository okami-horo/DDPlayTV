# Feature Specification: Libass GPU Subtitle Pipeline

**Feature Branch**: `001-libass-gpu-render`  
**Created**: 2025-11-27  
**Status**: Draft  
**Input**: User description: "优化当前项目的libass字幕渲染逻辑，把字幕渲染挪到原生渲染线程并交给 GPU 合成，从根本解决渲染卡顿问题。use exa获取相关文档和功能源码参考"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 流畅播放复杂字幕 (Priority: P1)

用户在播放包含复杂 ASS/SSA 效果（渐变、描边、模糊、卡拉 OK）的影片时，字幕始终流畅，与视频同步且无明显卡顿或 UI 卡死。

**Why this priority**: 直接消除现有卡顿痛点，是用户体验最核心价值。

**Independent Test**: 使用带复杂特效的 1080p/4K 字幕样本播放，观察字幕与画面同步、帧率稳定且 UI 不掉帧。

**Acceptance Scenarios**:

1. **Given** 设备打开高复杂度 ASS 字幕，**When** 开始播放视频，**Then** 字幕渲染保持与视频同步且无明显掉帧或顿挫。
2. **Given** 播放过程中用户调出控制栏，**When** 控制栏显示/隐藏，**Then** 字幕仍保持流畅且无 UI 卡顿。

---

### User Story 2 - 资源占用受控 (Priority: P2)

在中低端设备或长时间播放场景中，字幕渲染不会显著推高 CPU 占用或导致温度/续航异常，设备仍保持可交互。

**Why this priority**: 确保 GPU 管线收益转化为日常可用性，避免因资源争用带来新问题。

**Independent Test**: 在中端设备播放 20 分钟复杂字幕视频，监测交互流畅度与系统资源占用，无明显卡顿或过热。

**Acceptance Scenarios**:

1. **Given** 中端设备播放长视频并加载复杂字幕，**When** 连续播放 20 分钟，**Then** 用户交互流畅，系统未出现明显过热或响应迟滞。

---

### User Story 3 - 可用性与降级 (Priority: P3)

当 GPU 管线不可用（Surface 异常、驱动不支持等）时，播放器能及时降级到可用渲染路径，并提示或自动恢复，不中断观看。

**Why this priority**: 保证功能可用性和容错，避免因新管线导致播放中断。

**Independent Test**: 人为制造 Surface 重建或禁用硬件加速，验证能自动切换到备用路径并继续显示字幕。

**Acceptance Scenarios**:

1. **Given** 播放过程中发生渲染 Surface 变更或失效，**When** 系统重建 Surface，**Then** 字幕在数百毫秒内恢复显示且视频不中断。
2. **Given** 设备不支持目标 GPU 管线，**When** 用户加载 ASS 字幕，**Then** 播放器提示或自动切回兼容渲染，并继续播放。

---

### Edge Cases

- 设备切换横竖屏或分辨率变化时，字幕渲染目标尺寸变化是否平滑，无闪烁或花屏。
- 切换渲染视图类型（SurfaceView/TextureView）时字幕是否无感知衔接。
- 字幕轨道被禁用/替换/快进时，旧帧是否及时清理，不残留幽灵字幕。
- 后台切前台或多窗口模式下，GPU 上下文重建能否快速恢复字幕。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须提供 GPU 支持的 libass 字幕渲染管线，用于 ASS/SSA 外挂字幕的实时绘制与合成。
- **FR-002**: 渲染管线必须与视频帧同步，支持字幕时间偏移设置，并在播放、暂停、seek 后保持字幕对齐。
- **FR-003**: 必须在渲染视图类型切换（SurfaceView 与 TextureView）或尺寸变化时平滑迁移字幕输出，不出现花屏/闪烁。
- **FR-004**: 必须在 GPU 管线不可用、初始化失败或运行异常时自动降级到兼容渲染路径，并提示或记录错误，不中断播放。
- **FR-005**: 必须处理高复杂度字幕特效（渐变、描边、模糊、卡拉 OK 等）时维持目标帧率，不因字幕渲染导致可感知卡顿。
- **FR-006**: 必须避免字幕残影：字幕隐藏、轨道切换或无新帧时，旧帧需在可见区域内被清理。
- **FR-007**: 必须提供性能监测或日志钩子，用于捕获字幕渲染时延/丢帧信息，便于验证优化效果。

### Key Entities

- **字幕渲染管线状态**：记录当前渲染模式（GPU 管线、兼容/降级模式）、可用性与错误状态，用于切换和监控。
- **字幕帧输出目标**：与视频渲染视图关联的输出平面（随分辨率、旋转、视图类型变化而更新），承载最终合成的字幕画面。

### Assumptions

- 目标设备具备基础 GPU 加速能力；若 GPU 不可用时触发降级仍视为功能可用。
- 字幕字体与资源加载逻辑沿用现有机制，不在本特性范围新增字体管理需求。
- 性能目标以常见中端手机（近两年机型）为基准进行验证。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 在包含复杂 ASS 特效的 1080p/4K 视频播放中，字幕合成不引起可感知卡顿，95% 以上字幕帧在目标 vsync 窗口内完成。
- **SC-002**: 相比现有实现，复杂字幕播放场景下字幕渲染导致的 CPU 占用峰值下降至少 30%，设备交互无明显卡顿。
- **SC-003**: 在发生 Surface 重建或硬件加速不可用时，字幕恢复时间不超过 1 秒，播放不中断。
- **SC-004**: 长时间播放（≥20 分钟）中，未出现字幕残影或错位，用户报告的字幕卡顿/掉帧问题减少 80% 以上。
