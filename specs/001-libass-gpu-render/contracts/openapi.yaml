openapi: 3.0.3
info:
  title: Libass GPU Subtitle Pipeline Contracts
  version: 0.1.0
paths:
  /subtitle/pipeline/init:
    post:
      summary: Initialize or reinitialize GPU subtitle pipeline for a surface
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PipelineInitRequest'
      responses:
        '200':
          description: Pipeline initialization accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubtitlePipelineState'
  /subtitle/pipeline/status:
    get:
      summary: Fetch current subtitle pipeline state and output target
      responses:
        '200':
          description: Current pipeline state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PipelineStatusResponse'
  /subtitle/pipeline/fallback:
    post:
      summary: Force fallback or resume GPU mode
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FallbackCommand'
      responses:
        '200':
          description: Updated mode
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubtitlePipelineState'
  /subtitle/pipeline/telemetry:
    post:
      summary: Submit telemetry sample from render thread
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TelemetrySample'
      responses:
        '202':
          description: Telemetry accepted for aggregation
  /subtitle/pipeline/telemetry/latest:
    get:
      summary: Retrieve latest aggregated performance snapshot
      responses:
        '200':
          description: Aggregated metrics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TelemetrySnapshot'

components:
  schemas:
    PipelineInitRequest:
      type: object
      required: [surfaceId, viewType, width, height, rotation]
      properties:
        surfaceId:
          type: string
          description: Unique ID for current SurfaceView/TextureView
        viewType:
          type: string
          enum: [SurfaceView, TextureView]
        width:
          type: integer
          minimum: 1
        height:
          type: integer
          minimum: 1
        rotation:
          type: integer
          enum: [0, 90, 180, 270]
        scale:
          type: number
          format: float
          default: 1.0
        colorFormat:
          type: string
          example: RGBA_8888
        supportsHardwareBuffer:
          type: boolean
        vsyncId:
          type: integer
          format: int64
        telemetryEnabled:
          type: boolean
          default: true
    SubtitlePipelineState:
      type: object
      required: [mode, status]
      properties:
        mode:
          type: string
          enum: [GPU_GL, Fallback_CPU]
        status:
          type: string
          enum: [Initializing, Active, Degraded, Error]
        surfaceId:
          type: string
        eglContextId:
          type: string
        fallbackReason:
          type: string
          nullable: true
        lastError:
          type: string
          nullable: true
        lastRecoverAt:
          type: integer
          format: int64
          nullable: true
        telemetryEnabled:
          type: boolean
    PipelineStatusResponse:
      type: object
      properties:
        state:
          $ref: '#/components/schemas/SubtitlePipelineState'
        outputTarget:
          $ref: '#/components/schemas/SubtitleOutputTarget'
    SubtitleOutputTarget:
      type: object
      required: [viewType, width, height]
      properties:
        viewType:
          type: string
          enum: [SurfaceView, TextureView]
        width:
          type: integer
        height:
          type: integer
        scale:
          type: number
          format: float
          default: 1.0
        rotation:
          type: integer
        colorFormat:
          type: string
        supportsHardwareBuffer:
          type: boolean
        vsyncId:
          type: integer
          format: int64
    FallbackCommand:
      type: object
      required: [targetMode]
      properties:
        targetMode:
          type: string
          enum: [GPU_GL, Fallback_CPU]
        reason:
          type: string
          example: SURFACE_LOST
    TelemetrySample:
      type: object
      required: [timestampMs, subtitlePtsMs, renderLatencyMs, uploadLatencyMs, frameStatus]
      properties:
        timestampMs:
          type: integer
          format: int64
        subtitlePtsMs:
          type: integer
          format: int64
        renderLatencyMs:
          type: number
          format: float
        uploadLatencyMs:
          type: number
          format: float
        compositeLatencyMs:
          type: number
          format: float
        frameStatus:
          type: string
          enum: [Rendered, Dropped, Skipped]
        dropReason:
          type: string
          nullable: true
        cpuUsagePct:
          type: number
          format: float
          nullable: true
        gpuOverutilized:
          type: boolean
          nullable: true
        vsyncMiss:
          type: boolean
          nullable: true
    TelemetrySnapshot:
      type: object
      properties:
        windowMs:
          type: integer
          format: int64
        renderedFrames:
          type: integer
        droppedFrames:
          type: integer
        vsyncHitRate:
          type: number
          format: float
        cpuPeakPct:
          type: number
          format: float
        mode:
          type: string
          enum: [GPU_GL, Fallback_CPU]
        lastFallback:
          $ref: '#/components/schemas/FallbackEvent'
    FallbackEvent:
      type: object
      properties:
        timestampMs:
          type: integer
          format: int64
        fromMode:
          type: string
        toMode:
          type: string
        reason:
          type: string
        recoverable:
          type: boolean
