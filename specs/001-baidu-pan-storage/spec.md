# Feature Specification: 百度网盘存储库在线播放

**Feature Branch**: `[001-baidu-pan-storage]`  
**Created**: 2026-01-13  
**Status**: Draft  
**Input**: User description: "为当前项目直接对接集成百度网盘作为项目的storage存储库进行视频播放，类似alist等"

## Assumptions

- 用户拥有可用的百度网盘账号，并同意在应用内通过二维码扫码完成官方授权。
- 首期范围聚焦“浏览网盘文件 + 选择视频直接播放”，不包含上传、删除、移动、分享等文件管理能力。
- 仅覆盖个人网盘使用场景；企业/团队网盘、第三方转存等能力不在首期范围内。
- 播放体验遵循应用现有播放器交互（暂停/继续、拖动进度、横竖屏/TV 等由现有播放器能力提供）。
- 应用不要求用户输入百度账号密码；仅通过官方二维码扫码授权流程完成登录与授权，且用户体验与应用内现有“B 站扫码登录”保持一致（如展示二维码、扫码确认、可刷新/重试）。
- 该能力依赖百度网盘服务可用性与授权政策；如服务端策略变化可能影响可用性与体验。
- 百度网盘作为“存储源”的新增、管理、文件浏览、播放入口与交互路径应与应用内现有存储源保持一致（例如 AList、WebDAV、B 站等），除扫码授权页面外不引入独立的专用操作路径。
- 百度网盘授权实现基于百度开放平台 OAuth（设备码/扫码确认）；应用侧通过构建注入提供 `client_id`/`client_secret`。
- 授权完成后将持久化 `refresh_token` 并在需要时自动刷新 `access_token`；仅当刷新失败或用户撤销授权时才需要重新扫码。
- 百度网盘视频在线播放需兼容应用现有所有播放内核（Media3/Exo、mpv、VLC），且切换内核不应改变“能否播放”的结论。
- 百度网盘 OAuth 授权将遵循最小权限原则：仅申请满足“浏览目录 + 播放（读取/下载）”所需的最小 `scope/权限范围`。

## Clarifications

### Session 2026-01-13

- Q: 百度网盘“扫码授权登录”希望采用哪条实现路径？ → A: 仅采用百度开放平台 OAuth（设备码/扫码确认），应用内置（构建注入）`client_id`/`client_secret`。
- Q: 新增百度网盘存储源后，在应用内允许浏览的网盘范围是？ → A: 全盘可浏览：从网盘根目录开始（/）。
- Q: 百度网盘授权后的登录态策略是？ → A: 持久化 `refresh_token`，应用自动刷新 `access_token`；仅在刷新失败/用户撤销授权时要求重新扫码。
- Q: 百度网盘视频在线播放需要兼容哪些播放器内核？ → A: 兼容应用现有所有播放内核（Media3/Exo、mpv、VLC）。
- Q: 百度网盘 OAuth 授权时，`scope/权限范围` 采用哪种策略？ → A: 最小权限：仅申请满足“浏览目录 + 播放（读取/下载）”所需权限（如开放平台无只读粒度，则使用其最小可用权限集）。

## Out of Scope

- 账号密码登录、短信验证码登录等非扫码授权登录方式。
- 模拟网页版扫码登录（cookie/BDUSS 等）及其他非开放平台 OAuth 的鉴权方案。
- 默认申请超出“浏览+播放”所需范围的高权限 `scope`（如写入/管理权限）。
- 网盘文件的上传、删除、重命名、移动、复制、分享链接创建/管理。
- 网盘侧的离线下载/转存任务管理。
- 将网盘视频“完整下载到本地”作为首要播放路径（可作为后续增强）。
- 企业/团队网盘、跨租户共享空间等非个人网盘形态。

## User Scenarios & Testing *(mandatory)*

<!--
  IMPORTANT: User stories should be PRIORITIZED as user journeys ordered by importance.
  Each user story/journey must be INDEPENDENTLY TESTABLE - meaning if you implement just ONE of them,
  you should still have a viable MVP (Minimum Viable Product) that delivers value.
  
  Assign priorities (P1, P2, P3, etc.) to each story, where P1 is the most critical.
  Think of each story as a standalone slice of functionality that can be:
  - Developed independently
  - Tested independently
  - Deployed independently
  - Demonstrated to users independently
-->

### User Story 1 - 挂载百度网盘并播放视频 (Priority: P1)

用户在“存储/文件浏览”中新增一个“百度网盘”存储源，通过“二维码扫码授权登录”完成连接后可以浏览网盘目录，选择一个视频文件后直接进入播放器并开始播放。

**Why this priority**: 这是“像 alist 一样把网盘当作存储源来播放视频”的核心闭环；没有它就无法达成主要价值。

**Independent Test**: 使用一个包含至少 1 个视频文件的百度网盘测试账号：完成添加存储源 → 浏览到视频 → 点击播放，验证能进入播放器并成功开始播放。

**Acceptance Scenarios**:

1. **Given** 用户未添加过百度网盘存储源且网络可用，**When** 用户选择新增“百度网盘”，**Then** 系统展示可扫码的二维码与必要的操作指引（如“使用百度网盘 App 扫码确认”）
2. **Given** 系统已展示二维码且用户使用官方客户端扫码并确认授权，**When** 授权流程完成，**Then** 系统创建该存储源且展示网盘根目录（/）的文件列表
3. **Given** 用户已完成授权且目录中存在受支持的视频文件，**When** 用户点击该视频文件播放，**Then** 播放器打开并开始播放，且在返回后可回到原目录位置
4. **Given** 用户在扫码授权过程中取消、拒绝或超时，**When** 授权流程结束，**Then** 系统不创建存储源并给出可理解的提示与再次尝试入口
5. **Given** 二维码已过期或不可用，**When** 用户选择刷新或重试，**Then** 系统生成并展示新的可扫码二维码且授权流程可继续
6. **Given** 用户已熟悉应用内其他存储源的使用路径，**When** 用户使用百度网盘存储源进行浏览与播放，**Then** 其入口位置、返回行为、文件列表交互与播放入口与其他存储源保持一致（除扫码授权页外）

---

### User Story 2 - 在网盘中快速定位内容 (Priority: P2)

用户面对大体量网盘目录时，可以在应用内进行常用的定位操作（如按目录层级浏览、刷新列表、按名称/时间等排序、在当前存储范围内搜索），以便更快找到想看的视频。

**Why this priority**: 网盘内容通常规模大；缺少定位能力会导致“能挂载但难用”，显著影响完成播放任务的效率。

**Independent Test**: 使用包含多级目录和多文件类型的网盘：验证能正常浏览层级、刷新列表、排序和搜索，并能稳定返回正确结果。

**Acceptance Scenarios**:

1. **Given** 用户已添加百度网盘存储源且当前目录文件较多，**When** 用户执行刷新/排序/搜索操作，**Then** 列表结果与操作一致且不会破坏当前浏览上下文（如滚动位置、所在目录）

---

### User Story 3 - 存储源与授权状态可管理 (Priority: P3)

用户可以在设置/存储管理中查看百度网盘存储源的授权状态，并进行断开、重连/重新授权等操作；当授权失效或被撤销时，系统能引导用户恢复而不是让播放/浏览陷入不可理解的错误。

**Why this priority**: 网盘授权可能过期或被撤销；可管理性决定了该功能能否长期稳定使用。

**Independent Test**: 将测试账号授权置为失效（或模拟失效场景）：验证应用能检测到失效并引导重新授权；验证用户可移除存储源且相关信息被清理。

**Acceptance Scenarios**:

1. **Given** 百度网盘授权已失效或被撤销，**When** 用户进入该存储源或尝试播放文件，**Then** 系统提示需要重新授权并提供一键重连入口，且不会导致崩溃
2. **Given** 用户不再使用该存储源，**When** 用户选择移除百度网盘存储源，**Then** 系统从存储列表中移除并清理相关授权信息，后续不再访问该账号数据
3. **Given** 用户选择重新授权，**When** 系统进入重新授权流程，**Then** 系统展示二维码并允许用户完成扫码确认后恢复访问与播放
4. **Given** `access_token` 已过期但 `refresh_token` 仍有效，**When** 用户进入该存储源或尝试播放文件，**Then** 系统自动刷新并继续浏览/播放且无需重新扫码

### Edge Cases

<!--
  ACTION REQUIRED: The content in this section represents placeholders.
  Fill them out with the right edge cases.
-->

- 网络不可用或网络波动时：文件列表加载与播放应给出明确提示，并提供重试入口。
- 二维码获取失败或二维码过期：应提示原因，并提供刷新/重试入口。
- 用户设备无法完成扫码确认（例如未安装官方客户端）：应提示可行替代路径（如引导在另一设备扫码）或说明当前无法继续。
- 目录中文件数量极大时：列表应可继续滚动浏览且保持交互响应，不因单次加载导致长时间卡顿。
- 文件在网盘侧被删除/移动：打开目录或开始播放时应提示“文件不存在或已变更”，并允许返回上一级继续操作。
- 授权失效/被撤销：应能识别并引导重新授权，而不是只显示“未知错误”。
- `access_token` 过期：应自动刷新；若刷新失败则提示重新扫码授权。
- 不受支持的文件类型：应明确提示“当前文件无法播放”，且不进入播放器或进入后给出可理解的失败原因。
- 播放过程中临时中断（如切后台/弱网）：应尽量维持播放或允许用户手动恢复（重试/重新进入）。

## Requirements *(mandatory)*

<!--
  ACTION REQUIRED: The content in this section represents placeholders.
  Fill them out with the right functional requirements.
-->

### Functional Requirements

- **FR-001**: 系统必须允许用户新增“百度网盘”作为一个可选的存储源类型。
- **FR-002**: 系统必须基于百度开放平台 OAuth（设备码/扫码确认）提供“二维码扫码授权登录”方式来连接百度网盘，且不得要求用户输入百度账号密码。
- **FR-003**: 系统必须在授权成功后默认展示网盘根目录（/）下的目录与文件，并支持进入/返回目录层级浏览。
- **FR-004**: 系统必须在文件列表中展示用于决策的基础信息（名称、类型/层级位置、是否可播放），并在适当位置展示大小与修改时间。
- **FR-005**: 用户必须能够从百度网盘文件列表中选择受支持的视频文件，并通过应用现有播放入口直接开始播放。
- **FR-006**: 系统必须在浏览与播放过程中对常见失败给出可理解的提示（如网络问题、文件不存在、授权失效），并提供可恢复操作（如重试、重新授权、返回）。
- **FR-007**: 系统必须允许用户移除已添加的百度网盘存储源，并确保移除后不再访问该账号的数据。
- **FR-008**: 系统必须支持用户同时配置多个百度网盘存储源（例如多账号），并在界面上可区分且数据相互隔离。
- **FR-009**: 系统必须在授权失效或被撤销时，阻止继续访问并引导用户重新授权；恢复授权后可继续浏览与播放。
- **FR-010**: 系统必须为“百度网盘存储源”的关键操作提供可验证的结果（创建成功/失败、列表加载成功/失败、播放启动成功/失败）。
- **FR-011**: 系统必须将百度网盘以“存储源”的形态融入现有存储源体系，使用户在新增、选择、管理、文件浏览与播放等环节的入口与交互与其他存储源保持一致（除扫码授权页外）。
- **FR-012**: 系统必须持久化 `refresh_token` 并在 `access_token` 失效/过期时自动刷新；仅当刷新失败或用户撤销授权时才要求重新扫码授权。
- **FR-013**: 系统必须保证百度网盘视频在应用现有所有播放内核（Media3/Exo、mpv、VLC）下均可启动播放；切换播放内核不应改变“可播放/不可播放”的判断结果。
- **FR-014**: 系统必须在百度网盘 OAuth 授权时遵循最小权限原则：仅申请满足“浏览目录 + 播放（读取/下载）”所需的最小 `scope/权限范围`；不得默认申请写入/管理权限（若开放平台仅提供更粗粒度 scope，应选择其最小可用权限集）。

### Acceptance Criteria (by requirement)

- **FR-001**: 在新增存储源入口中可选择“百度网盘”，且新增成功后在存储列表中可见。
- **FR-002**: 连接流程展示可扫码二维码且不出现“百度账号/密码”输入项，并按百度开放平台 OAuth（设备码/扫码确认）完成授权；用户可取消、刷新二维码、重试，且每种结果均有明确提示。
- **FR-003**: 授权成功后默认可看到网盘根目录（/）的文件列表；进入与返回目录后列表内容正确且可继续操作。
- **FR-004**: 列表中可区分文件与目录；对视频文件有可播放提示；在详情页或列表中可查看大小与修改时间。
- **FR-005**: 点击受支持的视频文件可进入播放器并开始播放；点击不受支持的文件会被拦截并提示原因。
- **FR-006**: 断网/弱网、文件不存在、授权失效等场景下，用户能看到明确提示与可执行的恢复操作入口。
- **FR-007**: 用户移除存储源后，该存储源从列表消失；再次进入不再显示该账号内容且需要重新授权才可恢复。
- **FR-008**: 可添加至少 2 个百度网盘存储源；在不同存储源间切换时显示的数据互不混淆。
- **FR-009**: 授权失效时访问会被阻止并提示重新授权；重新授权成功后可继续浏览与播放。
- **FR-010**: 新增、加载列表、启动播放等关键操作均有“成功/失败”反馈；失败时包含可理解原因与下一步动作。
- **FR-011**: 百度网盘与其他存储源共用同一套入口与页面结构：新增入口在同一处、存储源列表呈现方式一致、文件浏览页面结构一致、播放入口一致、管理/移除入口一致；除扫码授权页外不出现“仅百度网盘可见”的独立流程。
- **FR-012**: 完成扫码授权后，用户关闭并重新打开应用仍可直接浏览网盘；当 `access_token` 过期时系统会自动刷新并继续使用；仅在刷新失败或用户撤销授权时提示重新扫码。
- **FR-013**: 在设置中分别切换 Media3/Exo、mpv、VLC 作为播放内核：点击同一个受支持的视频文件均可进入播放器并开始播放；若某内核启动失败，应给出明确提示并允许用户切换到其他内核重试。
- **FR-014**: 授权确认页（或等价的授权提示）中展示的权限范围不应包含写入/删除/管理等能力（或等价表述）；用户拒绝授权后系统不创建存储源并可重新发起授权。

### Key Entities *(include if feature involves data)*

- **百度网盘存储源**: 代表一个已添加的百度网盘连接（展示名、账号标识、授权状态、`access_token`、`refresh_token`、过期时间、最近一次成功访问时间）。
- **扫码授权会话**: 代表一次二维码授权登录流程（二维码、有效期、当前状态、最终结果）。
- **网盘文件项**: 代表一个目录或文件（名称、类型、路径/层级位置、可选的大小与修改时间）。
- **播放请求**: 代表一次从网盘文件启动播放的行为（目标文件、发起时间、结果状态、失败原因）。

## Success Criteria *(mandatory)*

<!--
  ACTION REQUIRED: Define measurable success criteria.
  These must be technology-agnostic and measurable.
-->

### Measurable Outcomes

- **SC-001**: 新用户从“新增存储源”开始，到完成扫码授权并看到网盘文件列表的流程，90% 的情况下可在 2 分钟内完成。
- **SC-002**: 用户点击一个受支持的视频文件后，80% 的情况下可在 5 秒内看到播放器开始播放（出现画面或听到声音）。
- **SC-003**: 在授权有效且网络可用的前提下，用户首次尝试从网盘播放视频的成功率达到 90% 以上。
- **SC-004**: 当授权失效或网络不可用时，用户能够通过提示完成“重试/重新授权/返回”的恢复操作，且无需强退应用即可继续使用其他功能（崩溃率 ≤ 0.5%）。
