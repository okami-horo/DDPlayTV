# Feature Specification: 集成 mpv 播放引擎

**Feature Branch**: `002-mpv-player-integration`  
**Created**: 2025-12-12  
**Status**: Draft  
**Input**: User description: "为当前项目集成mpv player供视频播放"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 选择并使用 mpv 播放视频 (Priority: P1)

作为应用用户，我希望在播放视频时可以选择 mpv 作为播放引擎，以获得更好的格式兼容性和播放稳定性。

**Why this priority**: 这是功能核心；没有可用的 mpv 播放能力则本需求无价值。

**Independent Test**: 在设置中切换到 mpv 后，打开任意可播放视频并能正常播放与控制。

**Acceptance Scenarios**:

1. **Given** 用户已安装应用且存在可播放视频源，**When** 在播放器设置中选择 mpv 并开始播放某视频，**Then** 视频能开始播放且音画同步，无明显卡顿或黑屏。
2. **Given** mpv 被选为播放引擎，**When** 用户进行播放/暂停、快进/快退、拖动进度、调整音量与倍速、切换全屏/方向等操作，**Then** 操作生效且 UI 状态与实际播放一致。

---

### User Story 2 - 与现有播放体验保持一致 (Priority: P2)

作为应用用户，我希望在使用 mpv 播放时，应用现有的关键播放能力（如弹幕/字幕显示与开关、播放列表/下一集、屏幕旋转与后台返回）仍可用或有明确的替代行为。

**Why this priority**: 避免因为切换播放引擎导致体验断层。

**Independent Test**: 使用 mpv 播放一段带弹幕/字幕的视频，逐一验证相关开关与控制。

**Acceptance Scenarios**:

1. **Given** 视频包含弹幕与字幕数据，**When** 用户在播放中打开/关闭弹幕或字幕，**Then** 叠加显示随开关即时变化且不影响播放。
2. **Given** 用户在播放列表中连续观看多集，**When** 当前视频播放结束或用户点击“下一集”，**Then** 自动/手动切换到下一集并继续使用 mpv 播放。

---

### User Story 3 - 失败时可回退且不崩溃 (Priority: P3)

作为应用用户，当 mpv 无法播放或发生错误时，我希望应用能给出可理解的提示，并允许我快速切换回默认播放引擎继续观看。

**Why this priority**: 提升稳定性与可恢复性，减少播放中断带来的挫败感。

**Independent Test**: 用一个 mpv 不可播放的样例触发错误并验证提示与回退。

**Acceptance Scenarios**:

1. **Given** mpv 播放某视频失败，**When** 错误发生，**Then** 应用展示明确的失败原因/建议，并提供“切换播放引擎重试”入口。
2. **Given** 用户选择回退，**When** 选择默认播放引擎并重试，**Then** 播放正常继续且不发生闪退。

### Edge Cases

- mpv 不支持或无法解码某些视频/音频/字幕格式时，应提示并允许回退。
- 网络流播放过程中断网、重连、跳转清晰度时，mpv 需保持可恢复或给出提示。
- 在后台/锁屏/分屏/画中画等系统状态切换时，mpv 播放状态应与应用策略一致，不出现资源泄露或黑屏。
- 设备性能较弱或高码率视频时，mpv 需避免无响应，并提供降级/回退路径。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 应用必须提供 mpv 作为可选播放引擎，并可在设置中切换。
- **FR-002**: 当 mpv 作为当前播放引擎时，应用必须支持播放本应用现有可播放来源的视频（本地文件与网络流）。
- **FR-003**: mpv 播放必须支持基本播放控制：播放/暂停、进度拖动/快进快退、音量、倍速、全屏/方向切换。
- **FR-004**: mpv 播放时，弹幕覆盖层必须保持可用，显示/隐藏与现有设置一致且不影响播放。
- **FR-005**: mpv 播放时，内嵌字幕与外挂字幕必须默认可正常显示，并支持字幕开关、轨道切换与时间偏移；用户不得看到重复字幕。
- **FR-006**: mpv 播放网络视频时，必须继续支持现有的访问鉴权与请求头策略，使原有可播资源仍可正常播放。
- **FR-007**: mpv 播放发生错误时，应用必须给出用户可理解的错误提示，并提供回退到默认播放引擎的重试入口。
- **FR-008**: 切换播放引擎不得导致用户播放历史、播放列表、进度记录等现有数据丢失。

### Key Entities *(include if feature involves data)*

- **播放引擎配置**: 用户选择的当前播放引擎及其偏好设置。
- **播放会话**: 一次视频播放过程中需要保留的状态（当前视频、进度、清晰度、弹幕/字幕开关等）。

### Constraints & Dependencies

- 在发布包含 mpv 引擎的版本前，必须完成许可证与发行合规评估，确保不影响应用分发与发布策略。
- 首阶段以“字幕正确显示、核心播放功能可用”为目标；字幕样式/字体/位置等高级定制能力不在首阶段范围。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 在新播放引擎下，用户对已有视频来源的首次播放成功率达到 95% 以上。
- **SC-002**: 在常见设备上，启用新播放引擎后的首帧展示时间平均不超过 3 秒。
- **SC-003**: 与播放相关的崩溃率不高于当前版本（回归测试后无新增高频崩溃）。
- **SC-004**: 试用新播放引擎的用户中，至少 70% 表示播放兼容性或稳定性有提升（通过内测反馈/问卷）。

## Assumptions

- mpv 作为可选播放引擎提供，默认仍使用现有引擎，用户可随时切换。
- 新播放引擎需要覆盖当前应用的主要播放来源（本地与网络流）。
- 若个别高级播放能力短期无法完全对齐，应提供明确提示与回退路径。
