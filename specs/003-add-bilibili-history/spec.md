# Feature Specification: 接入 Bilibili 历史记录媒体库

**Feature Branch**: `003-add-bilibili-history`  
**Created**: 2025-12-27  
**Status**: Draft  
**Input**: User description: "将bilibili作为媒体库接入当前项目，作为尝试本任务首先将bilibili的历史记录进行接入，详细说明在 TODOs/bilibili.md 文档中"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 浏览并播放历史记录 (Priority: P1)

作为应用用户，我希望在应用的媒体库中接入我的 Bilibili 账号，并像浏览其他媒体库一样进入“历史记录”，看到我最近观看过的视频列表；点击任意条目即可开始播放，以便快速续看与回顾内容。

**Why this priority**: 这是“把 Bilibili 当作媒体库”的最小可用闭环：没有可浏览、可播放的历史记录入口，用户无法在应用内直接消费 Bilibili 内容，本特性也无法被验证。

**Independent Test**: 使用一个已连接的 Bilibili 账号，完成“进入媒体库 → 打开历史记录 → 点击条目开始播放”的闭环即可独立验收。

**Acceptance Scenarios**:

1. **Given** 用户尚未连接 Bilibili 账号，**When** 用户进入 Bilibili 媒体库入口，**Then** 系统提示需要连接账号并提供二维码扫码登录入口，同时不展示任何历史记录内容。
2. **Given** 用户已成功连接 Bilibili 账号，**When** 用户打开“历史记录”，**Then** 系统展示按时间倒序排列的历史条目列表，且每个条目提供足够信息用于识别（例如标题、封面、UP 主、观看时间/进度等）。
3. **Given** 用户在历史列表中选择任意条目，**When** 用户点击该条目开始播放，**Then** 视频进入播放状态；若该条目因权限/下架等原因无法播放，系统给出用户可理解的提示并允许返回列表继续选择其他条目。
4. **Given** 历史条目存在上次观看进度信息，**When** 用户点击该条目开始播放，**Then** 系统默认从上次观看进度继续播放（若进度不可用则从头开始）。
5. **Given** 历史记录中存在非本阶段支持的条目类型，**When** 用户打开“历史记录”，**Then** 系统不展示这些条目；若过滤后列表为空，系统展示空态与原因说明。
6. **Given** 用户播放的是 Bilibili 媒体库条目，且该条目对应的 `cid` 可用，**When** 播放页加载弹幕轨道，**Then** 系统默认使用 Bilibili 弹幕 API 获取该 `cid` 的官方弹幕并自动加载；若弹幕获取失败，系统给出可理解提示且不影响视频播放。

---

### User Story 2 - 可用的刷新与加载更多 (Priority: P2)

作为应用用户，我希望历史记录列表可以刷新和加载更多，以便在历史条目较多时依然能稳定浏览，并在网络不佳时知道系统处于“加载中/失败/无更多”的哪种状态。

**Why this priority**: 历史记录天然是长列表；如果不能加载更多或在失败时无反馈，用户会误以为数据缺失或应用卡死，显著影响可用性。

**Independent Test**: 在不关注播放能力的前提下，仅通过“首次进入加载 → 下拉刷新 → 上拉加载更多 → 断网/重连”即可独立验证列表的可用性与状态提示。

**Acceptance Scenarios**:

1. **Given** 用户已连接账号且网络正常，**When** 用户进入历史记录列表并下拉刷新，**Then** 系统重新拉取并更新列表，同时展示明确的刷新状态。
2. **Given** 历史记录存在多页数据，**When** 用户滚动到列表底部触发加载更多，**Then** 系统追加展示更多历史条目，并在无更多内容时明确提示“已加载全部”或等效状态。
3. **Given** 网络不可用或服务不可用，**When** 用户尝试刷新或加载更多，**Then** 系统展示失败原因与重试入口，且不影响用户返回上一层或继续浏览已加载内容。

---

### User Story 3 - 账号断开与隐私控制 (Priority: P3)

作为应用用户，我希望可以随时断开 Bilibili 账号连接，并清除与该账号相关的本地数据（例如历史列表缓存等），以保障隐私与设备共享场景下的可控性。

**Why this priority**: 本特性涉及个人观看历史，隐私与可控性是基本底线；没有断开与清除能力会阻碍用户在公共设备或家庭共享设备上使用。

**Independent Test**: 在实现“断开连接/清除数据”后，通过“断开前可见历史 → 断开后不可见 → 重新连接后恢复访问”即可独立验证隐私控制。

**Acceptance Scenarios**:

1. **Given** 用户已连接账号且历史列表可见，**When** 用户执行“断开连接并清除数据”，**Then** 系统清除本地保存的账号连接信息、历史列表相关缓存，以及与 Bilibili 内容相关的本地播放历史/播放进度记录，并使历史记录入口回到未连接状态。
2. **Given** 用户已断开连接，**When** 用户再次进入 Bilibili 媒体库，**Then** 系统不展示任何个人历史内容，直到用户重新连接账号。
3. **Given** 用户正在播放 Bilibili 内容，**When** 用户执行“断开连接并清除数据”，**Then** 系统立即停止当前播放并退出播放页，同时完成断开与清除。

---

### Edge Cases

- 用户未连接账号或连接失效时，任何需要个人数据的入口都应被阻止并给出可理解提示。
- 历史条目指向的视频已下架、权限不足或区域受限时，应提示不可播放并允许继续浏览。
- 历史条目缺少或包含无效观看进度时，应从头开始播放，且不应导致播放失败或崩溃。
- 历史列表中包含非本阶段支持的条目类型时，应过滤不展示；若过滤后为空，应展示空态与原因说明（避免用户误以为加载失败）。
- Bilibili 弹幕获取失败（网络/接口变动/权限）时，应允许“无弹幕播放”，并提供重试或手动加载路径（与现有弹幕轨道机制一致）。
- 用户在播放过程中执行“断开连接并清除数据”时，应立即停止播放并退出播放页，避免在清除登录态后继续请求第三方内容导致异常体验。
- 网络切换（Wi‑Fi/移动网络）、弱网、代理网络等情况下，应避免“无限加载”，并可重试恢复。
- Android TV / 遥控器场景下，遥控器方向键焦点应能到达 Bilibili 媒体库入口、历史列表与条目，并可完成进入/返回/播放的基本操作。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须在应用的媒体库来源中提供 “Bilibili” 入口，用户可以进入该入口开始浏览。
- **FR-002**: 系统必须提供用户可理解的 Bilibili 账号连接/授权流程；本阶段连接方式为二维码扫码登录；在未连接前，系统不得展示或请求任何个人历史数据。
- **FR-003**: 系统必须在 Bilibili 媒体库中提供“历史记录”入口，并以列表形式展示用户的观看历史，默认按最近观看时间倒序排列。
- **FR-004**: 历史记录列表必须至少展示以下可识别信息：标题、封面、UP 主/作者（或等效来源信息）、观看时间或观看进度（若可用）。
- **FR-005**: 用户必须能够从任一历史条目发起播放；当历史条目存在上次观看进度时，系统必须默认从该进度继续播放（进度不可用则从头开始）；系统必须在播放失败时提供可理解的错误提示与重试/返回入口。
- **FR-006**: 历史记录列表必须支持刷新与加载更多，并在加载中/失败/无更多等状态下提供清晰反馈。
- **FR-007**: 系统必须提供“断开 Bilibili 连接并清除数据”的能力；断开后，系统不得继续展示历史记录内容，且用户重新连接前无法访问个人历史数据。
- **FR-008**: 当用户选择清除数据时，系统必须清除本地保存的与 Bilibili 账号连接相关的信息、与历史记录相关的本地缓存数据（若存在），以及与 Bilibili 内容相关的本地播放历史/播放进度记录。
- **FR-009**: 在 Android TV / 遥控器使用场景下，系统必须保证 Bilibili 媒体库入口、历史列表与条目的可达性与可操作性（遥控器方向键可导航、可确认、可返回）。
- **FR-010**: 本阶段系统必须仅展示“普通视频”类型的历史记录条目；其他类型条目不在列表中展示，且当过滤导致列表为空时必须展示空态与原因说明。
- **FR-011**: 当用户在播放 Bilibili 内容时执行“断开连接并清除数据”，系统必须立即停止当前播放并退出播放页，同时完成断开与清除。
- **FR-012**: 当播放来源为 Bilibili 媒体库条目时，系统必须优先使用 Bilibili 自身弹幕 API 按 `cid` 获取并加载官方弹幕（可缓存为本地弹幕文件）；不得使用弹弹play API 对 Bilibili 条目进行弹幕匹配作为默认路径。

### Out of Scope（本阶段不做）

- 不提供 Bilibili 收藏夹、稍后再看、搜索、UP 主空间等其他入口。
- 不提供离线下载、批量缓存或内容分发能力。
- 不提供多账号同时登录与账号切换（仅保证单账号可用；如需扩展另起规范）。
- 不提供 WebView 登录或手动导入 Cookie 等其他账号连接方式（除二维码扫码登录外）。
- 不支持番剧/影视、直播等非“普通视频”类型历史条目（本阶段不展示）。

### Key Entities *(include if feature involves data)*

- **Bilibili 账号连接信息**: 表示用户已连接的 Bilibili 身份，用于访问其个人历史数据；用户可随时断开并清除。
- **本地播放历史/进度记录**: 表示应用在本地保存的与播放相关的记录与续播进度，用于提升观看体验；在用户断开并清除时需要被清除以保障隐私。
- **历史记录条目**: 表示用户的一条观看记录，包含用于展示与播放所需的最小信息（标题、封面、来源信息、观看时间/进度、可播放目标等）。
- **历史条目类型**: 表示历史记录条目的内容类型，用于决定是否在本阶段展示与支持播放（本阶段仅支持“普通视频”）。
- **Bilibili 媒体库导航结构**: 表示在应用中呈现的“虚拟目录”结构（至少包含“历史记录”入口），用于让用户以媒体库方式浏览内容。
- **Bilibili 弹幕（cid 对应弹幕池）**: 表示与 Bilibili 视频分 P（cid）一一对应的官方弹幕数据；用于在播放时自动加载弹幕并可缓存到本地弹幕文件。

### Constraints & Dependencies

- 本功能依赖 Bilibili 的账号授权与内容服务可用性；当第三方服务不可用或规则变化时，系统应以“可理解提示 + 可恢复路径”为目标降级处理。
- 本功能涉及个人观看历史数据；系统必须提供明确的断开与清除能力，避免在共享设备上造成隐私泄露。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 在网络正常的情况下，用户进入“历史记录”后 3 秒内看到首屏列表内容的成功率达到 95% 以上（以内部测试统计为准）。
- **SC-002**: 用户从历史列表点击条目开始播放的成功率达到 95% 以上（对可正常播放的内容样本集），且失败时可在 2 次内通过重试或更换条目恢复观看。
- **SC-003**: 在不提供额外教学的情况下，90% 的内测用户可在 2 分钟内完成“连接账号 → 打开历史记录 → 播放一个条目”的完整流程。
- **SC-004**: 用户断开连接并清除数据后，再次进入 Bilibili 媒体库时，个人历史记录不可见且不可访问（在重新连接前），并通过抽检验证不残留可用于直接访问个人历史数据的本地信息。

### 验证路径

- 使用至少 2 个不同账号进行端到端验证：连接/进入历史/播放/断开与清除。
- 覆盖至少 30 条历史条目样本，包含：可正常播放、已下架/不可播放、需要更高权限等情况（以提示与可恢复为验收目标）。
- 覆盖手机与 TV（遥控器）两类交互场景，验证可达性与基本操作闭环。

## Assumptions

- 用户拥有可正常访问 Bilibili 的网络环境与合法账号。
- 历史记录仅用于用户个人浏览与播放，不作为内容下载或二次分发能力提供。
- 本阶段以“历史记录可用、可播放、可断开清除”为目标；更丰富的媒体库入口（收藏夹/稍后再看/搜索）属于后续阶段。

## Clarifications

### Session 2025-12-27

- Q: Bilibili 账号连接方式选哪种？ → A: 二维码扫码登录（扫码确认授权）
- Q: 从历史条目点击播放时，默认从哪里开始？ → A: 默认从上次观看进度续播（若可用）
- Q: 本阶段“历史记录”支持哪些条目类型？ → A: 仅支持普通视频（稿件/多 P）；其他类型不展示
- Q: 断开并清除时，是否清除本地播放历史/进度？ → A: 同时清除应用内所有 Bilibili 条目的本地播放历史/进度记录
- Q: 用户在播放 Bilibili 内容时执行“断开连接并清除数据”，当前播放如何处理？ → A: 立即停止播放并退出播放页，同时完成断开与清除
