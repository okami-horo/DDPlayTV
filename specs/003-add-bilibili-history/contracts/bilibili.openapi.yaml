openapi: 3.0.3
info:
  title: Bilibili Web API（本功能使用子集）
  version: 0.1.0
  description: |
    本文件描述“接入 Bilibili 历史记录媒体库”阶段会调用的 Bilibili Web API 子集，
    用于实现：二维码扫码登录、历史记录列表、分 P 列表、取流（DASH/MP4）、Bilibili 弹幕（XML）与 Cookie 刷新。

    注意：
    - 多数接口依赖 Cookie（SESSDATA 等）与 Referer/User-Agent。
    - playurl 依赖 WBI 签名（wts/w_rid）。

servers:
  - url: https://api.bilibili.com
    description: 业务 API
  - url: https://passport.bilibili.com
    description: 登录/刷新 Cookie
  - url: https://www.bilibili.com
    description: 对应部分刷新链路（correspond）
  - url: https://comment.bilibili.com
    description: 弹幕 XML（comment 域名）

tags:
  - name: Auth
    description: 登录/刷新
  - name: History
    description: 历史记录
  - name: Video
    description: 视频信息与取流
  - name: Danmaku
    description: 视频弹幕（按 cid 直接拉取）

components:
  securitySchemes:
    CookieAuth:
      type: apiKey
      in: header
      name: Cookie
      description: |
        使用 Cookie Header 进行鉴权（至少包含 SESSDATA；部分接口还需要 bili_jct 等）。
    WbiSignature:
      type: apiKey
      in: query
      name: w_rid
      description: |
        WBI 签名参数之一。wts 为秒级时间戳；w_rid 为 md5(query + mixin_key)。
  parameters:
    Referer:
      name: Referer
      in: header
      required: false
      schema:
        type: string
      description: 推荐设置为 https://www.bilibili.com/
    UserAgent:
      name: User-Agent
      in: header
      required: false
      schema:
        type: string
      description: 推荐设置为桌面浏览器 UA（Web API 更稳定）
    AcceptEncoding:
      name: Accept-Encoding
      in: header
      required: false
      schema:
        type: string
      description: |
        建议设置为 gzip,deflate。
        弹幕 XML 常以 deflate 压缩返回；客户端需允许自动解压或自行处理。
  schemas:
    CommonResponse:
      type: object
      properties:
        code:
          type: integer
        message:
          type: string
        ttl:
          type: integer
      required: [code, message]
    QrcodeGenerateData:
      type: object
      properties:
        url:
          type: string
        qrcode_key:
          type: string
      required: [url, qrcode_key]
    QrcodeGenerateResponse:
      allOf:
        - $ref: '#/components/schemas/CommonResponse'
        - type: object
          properties:
            data:
              $ref: '#/components/schemas/QrcodeGenerateData'
    QrcodePollData:
      type: object
      properties:
        url:
          type: string
        refresh_token:
          type: string
        timestamp:
          type: integer
          description: 毫秒时间戳
        code:
          type: integer
          description: 0 成功；86101 未扫码；86090 已扫码未确认；86038 已失效
        message:
          type: string
    QrcodePollResponse:
      allOf:
        - $ref: '#/components/schemas/CommonResponse'
        - type: object
          properties:
            data:
              $ref: '#/components/schemas/QrcodePollData'
    NavWbiImg:
      type: object
      properties:
        img_url:
          type: string
        sub_url:
          type: string
    NavData:
      type: object
      properties:
        isLogin:
          type: boolean
        wbi_img:
          $ref: '#/components/schemas/NavWbiImg'
    NavResponse:
      allOf:
        - $ref: '#/components/schemas/CommonResponse'
        - type: object
          properties:
            data:
              $ref: '#/components/schemas/NavData'
    HistoryCursor:
      type: object
      properties:
        max:
          type: integer
        view_at:
          type: integer
        business:
          type: string
        ps:
          type: integer
    HistoryItemHistory:
      type: object
      properties:
        bvid:
          type: string
        cid:
          type: integer
        business:
          type: string
        page:
          type: integer
        part:
          type: string
    HistoryItem:
      type: object
      properties:
        title:
          type: string
        cover:
          type: string
        author_name:
          type: string
        view_at:
          type: integer
        progress:
          type: integer
          description: 秒
        duration:
          type: integer
          description: 秒
        videos:
          type: integer
        history:
          $ref: '#/components/schemas/HistoryItemHistory'
    HistoryCursorData:
      type: object
      properties:
        cursor:
          $ref: '#/components/schemas/HistoryCursor'
        list:
          type: array
          items:
            $ref: '#/components/schemas/HistoryItem'
    HistoryCursorResponse:
      allOf:
        - $ref: '#/components/schemas/CommonResponse'
        - type: object
          properties:
            data:
              $ref: '#/components/schemas/HistoryCursorData'
    PagelistItem:
      type: object
      properties:
        cid:
          type: integer
        page:
          type: integer
        part:
          type: string
        duration:
          type: integer
          description: 秒
    PagelistResponse:
      allOf:
        - $ref: '#/components/schemas/CommonResponse'
        - type: object
          properties:
            data:
              type: array
              items:
                $ref: '#/components/schemas/PagelistItem'

paths:
  /x/passport-login/web/qrcode/generate:
    get:
      tags: [Auth]
      summary: 申请二维码（Web）
      servers:
        - url: https://passport.bilibili.com
      parameters:
        - $ref: '#/components/parameters/Referer'
        - $ref: '#/components/parameters/UserAgent'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QrcodeGenerateResponse'

  /x/passport-login/web/qrcode/poll:
    get:
      tags: [Auth]
      summary: 轮询二维码扫码状态（Web）
      servers:
        - url: https://passport.bilibili.com
      parameters:
        - name: qrcode_key
          in: query
          required: true
          schema:
            type: string
        - $ref: '#/components/parameters/Referer'
        - $ref: '#/components/parameters/UserAgent'
      responses:
        '200':
          description: OK（成功时响应头会下发 Set-Cookie）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QrcodePollResponse'

  /x/web-interface/nav:
    get:
      tags: [Auth]
      summary: 导航栏用户信息（包含 wbi_img）
      security:
        - CookieAuth: []
      parameters:
        - $ref: '#/components/parameters/Referer'
        - $ref: '#/components/parameters/UserAgent'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NavResponse'

  /x/web-interface/history/cursor:
    get:
      tags: [History]
      summary: 获取历史记录列表（cursor）
      security:
        - CookieAuth: []
      parameters:
        - name: max
          in: query
          required: false
          schema:
            type: integer
        - name: business
          in: query
          required: false
          schema:
            type: string
          description: archive/pgc/live/article...
        - name: view_at
          in: query
          required: false
          schema:
            type: integer
          description: 秒级时间戳（0 表示当前时间）
        - name: type
          in: query
          required: false
          schema:
            type: string
            enum: [all, archive, live, article]
          description: 建议使用 archive 仅拉“普通视频（稿件）”
        - name: ps
          in: query
          required: false
          schema:
            type: integer
            maximum: 30
        - $ref: '#/components/parameters/Referer'
        - $ref: '#/components/parameters/UserAgent'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HistoryCursorResponse'

  /x/player/pagelist:
    get:
      tags: [Video]
      summary: 查询视频分 P 列表（bvid -> cid）
      parameters:
        - name: bvid
          in: query
          required: false
          schema:
            type: string
        - name: aid
          in: query
          required: false
          schema:
            type: integer
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PagelistResponse'

  /x/player/wbi/playurl:
    get:
      tags: [Video]
      summary: 获取视频流地址（Web，需 WBI）
      security:
        - CookieAuth: []
          WbiSignature: []
      parameters:
        - name: bvid
          in: query
          required: true
          schema:
            type: string
        - name: cid
          in: query
          required: true
          schema:
            type: integer
        - name: qn
          in: query
          required: false
          schema:
            type: integer
          description: |
            画质偏好（如 64=720P、80=1080P、112=1080P+、120=4K）。
            注意：DASH 模式下通常需要在响应的 dash.video[] 中按 id 选择实际码流。
        - name: fnval
          in: query
          required: false
          schema:
            type: integer
          description: |
            视频流格式标识（位掩码）：
            - 1：MP4
            - 16：DASH
            - 128：允许 4K（与 fourk=1 协同；通常也需要 qn=120 且账号具备权限）
        - name: fnver
          in: query
          required: false
          schema:
            type: integer
            default: 0
        - name: fourk
          in: query
          required: false
          schema:
            type: integer
            default: 0
          description: 是否允许 4K（0/1）
        - name: codecid
          in: query
          required: false
          schema:
            type: integer
          description: |
            视频编码偏好（DASH）：7=AVC/H.264，12=HEVC/H.265，13=AV1。
            实际可用性以服务端返回为准。
        - name: platform
          in: query
          required: false
          schema:
            type: string
            default: pc
        - name: wts
          in: query
          required: true
          schema:
            type: integer
          description: 秒级时间戳
        - name: w_rid
          in: query
          required: true
          schema:
            type: string
          description: WBI 签名（md5）
        - $ref: '#/components/parameters/Referer'
        - $ref: '#/components/parameters/UserAgent'
      responses:
        '200':
          description: OK（响应结构较大，本阶段仅解析播放所需字段）

  /x/v1/dm/list.so:
    get:
      tags: [Danmaku]
      summary: 获取实时弹幕（XML，list.so）
      description: |
        返回 XML 弹幕内容（与 `https://comment.bilibili.com/{cid}.xml` 等价）。
        注意：该接口可能使用 deflate 压缩返回；建议带 `Accept-Encoding: gzip,deflate` 并确保客户端能正确解压。
      parameters:
        - name: oid
          in: query
          required: true
          schema:
            type: integer
          description: 视频 cid
        - $ref: '#/components/parameters/Referer'
        - $ref: '#/components/parameters/UserAgent'
        - $ref: '#/components/parameters/AcceptEncoding'
      responses:
        '200':
          description: OK（XML）
          content:
            application/xml:
              schema:
                type: string

  /{cid}.xml:
    get:
      tags: [Danmaku]
      summary: 获取实时弹幕（XML，comment 域名）
      servers:
        - url: https://comment.bilibili.com
      description: |
        返回 XML 弹幕内容。
        注意：该接口可能使用 deflate 压缩返回；建议带 `Accept-Encoding: gzip,deflate` 并确保客户端能正确解压。
      parameters:
        - name: cid
          in: path
          required: true
          schema:
            type: integer
          description: 视频 cid
        - $ref: '#/components/parameters/Referer'
        - $ref: '#/components/parameters/UserAgent'
        - $ref: '#/components/parameters/AcceptEncoding'
      responses:
        '200':
          description: OK（XML）
          content:
            application/xml:
              schema:
                type: string
