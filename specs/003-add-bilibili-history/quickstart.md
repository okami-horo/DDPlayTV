# Quickstart（Bilibili 历史记录媒体库）

本文用于在功能实现完成后，快速进行本地验证与验收复现。

Spec 路径：`/home/tzw/workspace/DanDanPlayForAndroid/specs/003-add-bilibili-history/spec.md`

---

## 0. 说明（本地已跑过的命令）

- 已通过：`./gradlew testDebugUnitTest`
- 已通过：`./gradlew lintDebug`

说明：本文仍以“真机/模拟器 + 实际 B 站账号”的端到端验收为准。

## 1. 构建与安装

在仓库根目录执行：

```bash
cd /home/tzw/workspace/DanDanPlayForAndroid
./gradlew assembleDebug
```

安装到设备/模拟器（示例）：

```bash
adb install -r app/build/outputs/apk/debug/*.apk
```

---

## 2. 首次连接账号（二维码扫码登录）

1. 打开 App → 进入“媒体库”
2. 点击“新增网络媒体库”
3. 选择 “Bilibili”
4. 进入 Bilibili 媒体库时，按提示打开“二维码扫码登录”
5. 使用手机 B 站 App 扫码并确认登录

预期：

- 登录前不展示任何历史记录内容
- 登录成功后可进入“历史记录”目录

---

## 2.1（可选）设置播放偏好

1. 打开 App → 进入“媒体库”
2. 长按/管理 Bilibili 媒体库 → 编辑
3. 在“播放偏好”中按需调整：
   - 取流模式（DASH/MP4）
   - 画质优先（qn）
   - 视频编码优先（codecid）
   - 允许 4K

预期：

- 保存后再次播放 Bilibili 条目时生效（具体生效时机取决于取流实现：重新取流后生效）

---

## 3. 浏览历史记录

1. 进入：媒体库 → Bilibili → 历史记录
2. 确认列表按时间倒序展示
3. 向下滚动触发“加载更多”
4. 触发刷新（触屏下拉；TV/遥控器可按菜单键刷新）

预期：

- 加载中/失败/无更多状态清晰可见
- 非普通视频类型条目被过滤；过滤后为空时展示空态与原因说明（Spec: FR-010）

---

## 4. 播放与续播

1. 在历史列表点击任一条目
2. 进入播放页

预期：

- 默认从历史进度续播（进度不可用则从头）
- 弹幕：若开启“自动匹配弹幕/自动加载弹幕”（以 App 现有弹幕设置为准），播放 Bilibili 条目时应自动拉取并加载该 `cid` 的 Bilibili 官方弹幕；失败时允许无弹幕播放且可重试
- 若条目不可播放（下架/权限/区域限制等），给出可理解提示，并可返回列表继续选择

---

## 5. 断开连接并清除数据

1. 在 Bilibili 媒体库管理页执行“断开连接并清除数据”

预期：

- 清除账号连接信息（Cookie/refresh_token 等）、历史缓存（若有）、以及本地 Bilibili 播放历史/进度
- 若清除时正在播放 Bilibili 内容：立即停止播放并退出播放页（Spec: FR-011）

---

## 6. TV/遥控器验证要点

- 遥控器 DPAD 能到达：Bilibili 入口 → 历史记录入口 → 条目 → 返回
- “加载更多/重试”在列表底部可聚焦并触发；“刷新”可通过菜单键触发（避免仅支持手势）

---

## 7. 差异与待补齐（请验收时重点关注）

- **FR-010 空态原因说明**：当前实现会过滤非“普通视频”类型历史（如直播/番剧等），但“过滤后为空时的原因说明”尚未单独实现（目前表现为列表为空）。
- **播放失败提示（FR-005）**：当前主要依赖异常 message/Toast 提示，建议在验收时覆盖“下架/权限/地区限制”等样本，确认提示是否足够可理解且可恢复（可返回列表继续选）。
- **历史首屏缓存（体验权衡）**：为提升“进入历史目录首屏可见”命中率，加入了首屏缓存；因此首次进入可能先展示短时间内的旧数据，按“刷新”可获取最新列表。
- **TV 可达性（FR-009）**：已提供“加载更多/重试/无更多”的可聚焦入口与菜单键刷新，但仍建议按真实遥控器路径逐项确认焦点可达与可操作性。
