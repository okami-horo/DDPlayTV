# Feature Specification: 115 Open 存储库在线播放

**Feature Branch**: `[001-115-open-storage]`  
**Created**: 2026-01-14  
**Status**: Draft  
**Input**: User description: "为当前项目原生集成115 open存储库，具体交互体验和百度网盘存储库保持一致。具体api可以参考 OpenList (Alist)项目对115 open的集成支持。登录鉴权也和OpenList的做法一样，直接在存储库选项中让用户手动输入accesstoken和refreshtoken即可。"

## Assumptions

- 用户已自行从 115 Open 获取到可用的 `access_token` 与 `refresh_token`（用于授权访问的凭证字符串），并愿意将其粘贴到应用内完成连接。
- 首期范围聚焦“浏览 115 文件 + 选择视频直接播放”，不包含上传、删除、移动、分享等文件管理能力。
- 播放体验遵循应用现有播放器交互（暂停/继续、拖动进度、TV 遥控等由现有播放器能力提供）。
- 115 Open 视频播放需兼容应用现有所有播放内核（Media3/Exo、mpv、VLC），且切换内核不应改变“能否播放”的结论。
- 115 Open 作为“存储源”的新增、管理、文件浏览、播放入口与交互路径与应用内现有存储源保持一致（与“百度网盘存储源”的浏览/播放体验对齐），仅在鉴权方式上不同（手动输入 token）。
- 该能力依赖 115 Open 服务可用性与授权策略；如服务端策略变化可能影响可用性与体验。

## Clarifications

### Session 2026-01-14

- Q: 新增 115 Open 存储源时，应用侧用于“唯一标识该账号/存储源”的 key 采用哪种策略？（影响：多账号隔离、重复添加处理、数据库唯一约束） → A: 通过 115 Open 的“用户信息”接口获取 `uid`，并将 `MediaLibraryEntity.url` 固定为 `115open://uid/<uid>`（同 `uid` 视为同账号）。
- Q: 115 Open 的文件列表页（与百度网盘存储源对齐）在首期 MVP 需要支持哪些“定位/操作”能力？ → A: 完全对齐百度网盘：支持刷新 + 排序（沿用应用现有排序选项）+ 搜索（在当前目录递归范围内）。
- Q: 115 Open 的 `access_token` / `refresh_token` 在本地的持久化与保护策略采用哪种？（影响：安全性、跨进程/重启可用性、实现复杂度） → A: 参考百度网盘：使用 MMKV 按 `storageKey` 隔离持久化 `refresh_token`/`access_token`/过期时间；UI 遮罩，日志不输出完整 token；移除存储源时清理。
- Q: 115 Open 视频播放需要兼容哪些播放器内核？（影响：播放链路设计、本地代理/Range 适配、验收覆盖范围） → A: 兼容应用现有所有播放内核（Media3/Exo、mpv、VLC）。
- Q: 115 Open 的“搜索”结果范围希望是哪一种？（影响：API 调用、UI 展示、验收用例） → A: 仅返回匹配的可播放视频文件。

## Out of Scope

- 账号密码登录、短信验证码登录等非 token 录入方式。
- 模拟网页版登录（Cookie 等）及其他非 115 Open 的鉴权方案。
- 网盘文件的上传、删除、重命名、移动、复制、分享链接创建/管理。
- 115 侧离线下载/转存任务管理。
- 将网盘视频“完整下载到本地”作为首要播放路径（可作为后续增强）。

## User Scenarios & Testing *(mandatory)*

<!--
  IMPORTANT: User stories should be PRIORITIZED as user journeys ordered by importance.
  Each user story/journey must be INDEPENDENTLY TESTABLE - meaning if you implement just ONE of them,
  you should still have a viable MVP (Minimum Viable Product) that delivers value.
  
  Assign priorities (P1, P2, P3, etc.) to each story, where P1 is the most critical.
  Think of each story as a standalone slice of functionality that can be:
  - Developed independently
  - Tested independently
  - Deployed independently
  - Demonstrated to users independently

  依赖治理提醒（本项目强约束）：
  - 避免 feature ↔ feature 的模块依赖；跨业务交互通过 `:core_contract_component` 契约/路由/Service
  - 共享类型优先下沉到 `:core_contract_component` / `:data_component`，避免实现层成为类型出口
  - 若此用户故事必须打破独立性或引入新的模块依赖，必须在本节显式说明原因与替代方案
 -->


### User Story 1 - 挂载 115 Open 并浏览文件 (Priority: P1)

用户在“存储/文件浏览”中新增一个“115 Open”存储源，通过在存储源选项中手动输入 `access_token` 与 `refresh_token` 完成连接后，可以从根目录开始浏览 115 文件列表，并可进入/返回目录继续浏览。

**Why this priority**: 这是“把 115 Open 当作存储源来使用”的最小闭环；先能挂载与浏览，才能支撑后续播放与更多操作。

**Independent Test**: 使用一个包含至少 1 个目录与 1 个视频文件的 115 账号：完成添加存储源 → 看到根目录列表 → 进入子目录并返回，验证列表内容正确且可持续操作。

**Acceptance Scenarios**:

1. **Given** 用户未添加过 115 Open 存储源且网络可用，**When** 用户选择新增“115 Open”，**Then** 系统展示需要填写的 `access_token` 与 `refresh_token` 输入项，并明确提示“无需账号密码”
2. **Given** 用户已填入 token 且 token 有效，**When** 用户确认保存，**Then** 系统创建该存储源并展示根目录的文件列表
3. **Given** 用户正在浏览目录，**When** 用户进入任一子目录并返回，**Then** 系统展示对应目录的文件列表且不会混淆层级
4. **Given** token 无效/缺失或网络不可用，**When** 用户确认保存或加载列表，**Then** 系统给出可理解的失败原因与可恢复操作（编辑 token、重试、返回）

---

### User Story 2 - 从 115 Open 选择视频并播放 (Priority: P2)

用户在 115 Open 的文件列表中选择一个受支持的视频文件后，系统使用应用现有播放入口进入播放器并开始播放；播放过程中用户可使用应用既有的播放器能力进行控制。

**Why this priority**: 用户引入网盘存储源的主要目的通常是“在线播放”；在完成挂载与浏览后，这一能力决定了核心体验是否成立。

**Independent Test**: 在已成功挂载 115 Open 的前提下：从列表选择一个视频文件 → 进入播放器 → 播放开始（出现画面或听到声音）。

**Acceptance Scenarios**:

1. **Given** 用户已成功挂载 115 Open 且目录中存在受支持的视频文件，**When** 用户点击视频文件，**Then** 系统进入播放器并开始播放
2. **Given** 用户点击不受支持的文件类型，**When** 系统判断不可播放，**Then** 系统拦截播放并提示原因（如“不支持的格式”），且不崩溃
3. **Given** 用户已进入播放器，**When** 用户返回到文件列表，**Then** 系统保持在原目录位置且可继续选择其他文件

---

### User Story 3 - 在 115 Open 中快速定位内容 (Priority: P3)

用户面对大体量 115 目录时，可以在应用内进行常用的定位操作（刷新列表、排序、搜索并返回匹配的可播放视频），以便更快找到想看的视频；交互与百度网盘存储源保持一致。

**Why this priority**: 115 目录可能规模较大；缺少定位能力会导致“能挂载但难用”，显著影响完成播放任务的效率。

**Independent Test**: 使用包含多级目录和多文件类型的 115：验证能正常浏览层级、刷新列表、排序和搜索，并能稳定返回正确结果。

**Acceptance Scenarios**:

1. **Given** 用户已添加 115 Open 存储源且当前目录文件较多，**When** 用户执行刷新/排序/搜索操作，**Then** 列表结果与操作一致且不会破坏当前浏览上下文（如滚动位置、所在目录），且搜索结果仅返回匹配的可播放视频文件

---

### User Story 4 - Token 失效后的可恢复体验 (Priority: P4)

当用户的 token 过期、被撤销或不再可用时，系统应在浏览与播放时给出明确提示，并引导用户通过“编辑 token / 重试 / 移除存储源”等方式恢复使用；在可行时系统可自动尝试使用 `refresh_token` 续期以减少打断。

**Why this priority**: 网盘类能力不可避免会遇到鉴权失效；清晰可恢复的体验可降低用户困惑与支持成本。

**Independent Test**: 使用一个会触发鉴权失效的账号场景：浏览时触发失败 → 系统提示并提供编辑入口 → 更新 token 后可继续浏览/播放。

**Acceptance Scenarios**:

1. **Given** 用户已添加 115 Open 存储源但访问时鉴权失效，**When** 用户打开目录或开始播放，**Then** 系统阻止继续访问并提示“授权失效/需要更新 token”，同时提供“编辑 token”入口
2. **Given** 系统提示可恢复操作，**When** 用户更新 token 并保存成功，**Then** 用户无需重新添加存储源即可继续浏览与播放
3. **Given** 用户选择移除存储源，**When** 用户确认移除，**Then** 该存储源从列表消失且不再访问该账号数据

---

### Edge Cases

- 用户仅填写了其中一个 token 或 token 包含多余空格/换行。
- `access_token` 已过期但 `refresh_token` 仍可用：应能在不中断用户操作的情况下恢复访问（如可行）。
- `refresh_token` 也已失效：应明确提示并引导用户更新 token。
- 重复添加同一 115 账号（同 `uid`）：应提示并引导用户对既有存储源进行编辑/更新，而不是创建重复存储源。
- 搜索关键词仅空格/为空：应退出搜索并恢复当前目录列表。
- 搜索关键词过长：应明确提示并不发起搜索请求（建议与现有存储源一致，例如最多 30 字符）。
- 目录包含大量文件/深层路径：列表仍可加载与滚动，且不会卡死或崩溃。
- 文件在播放前后被删除/被移动/权限变化：应提示并允许返回重试。
- 网络不稳定、请求超时：应支持重试且提示可理解。
- 用户同时配置多个 115 Open 存储源：切换时数据不串号、不混淆。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须在“新增存储源/存储库”的可选列表中提供“115 Open”作为可选存储源类型。
- **FR-002**: 系统必须允许用户在添加/编辑“115 Open 存储源”时手动填写 `access_token` 与 `refresh_token`；不得要求用户输入 115 账号密码。
- **FR-003**: 系统必须在用户保存存储源配置后，对 token 的可用性给出可验证结果（创建成功/失败、失败原因），并提供可恢复操作（编辑 token、重试、取消）。
- **FR-004**: 系统必须允许用户从 115 Open 根目录开始浏览文件与目录，并支持进入/返回目录；列表中需可区分文件与目录，并展示与应用现有存储源一致的基础信息呈现（如名称、类型、可选的大小与修改时间等）。
- **FR-005**: 用户必须能够从 115 Open 文件列表中选择受支持的视频文件，并通过应用现有播放入口直接开始播放。
- **FR-006**: 系统必须在浏览与播放过程中对常见失败给出可理解的提示（如网络问题、文件不存在、授权失效），并提供可恢复操作（重试、编辑 token、移除存储源、返回）。
- **FR-007**: 系统必须允许用户移除已添加的 115 Open 存储源，并确保移除后不再访问该账号的数据。
- **FR-008**: 系统必须支持用户同时配置多个 115 Open 存储源（例如多账号），并在界面上可区分且数据相互隔离。
- **FR-009**: 系统必须在鉴权失效或被撤销时，阻止继续访问并引导用户更新 token；更新成功后可继续浏览与播放。
- **FR-010**: 系统必须在可行时使用 `refresh_token` 自动续期/刷新 `access_token`，以减少用户操作被中断；仅当刷新失败或用户撤销授权时才要求用户手动更新 token。
- **FR-011**: 系统必须将 115 Open 以“存储源”的形态融入现有存储源体系，使用户在新增、选择、管理、文件浏览与播放等环节的入口与交互与“百度网盘存储源”保持一致（除鉴权方式差异外）。
- **FR-012**: 系统必须保护用户填写的 token 不被意外暴露（例如在可见界面中泄露完整值、在错误提示或日志中输出完整值），并允许用户在需要时进行更新。
- **FR-013**: 系统必须保证 115 Open 视频在应用现有所有播放内核（Media3/Exo、mpv、VLC）下均可启动播放；切换播放内核不应改变同一文件“可播放/不可播放”的判断结论（若某一内核启动失败，应给出可理解提示并允许切换重试）。
- **FR-014**: 系统必须通过 115 Open 的“用户信息”接口获取 `uid` 作为账号唯一标识，并以 `115open://uid/<uid>` 作为该存储源在本地持久化的唯一 URL；同 `uid` 不得重复添加，应引导用户改为编辑/更新既有存储源。
- **FR-015**: 系统必须在 115 Open 文件浏览页提供与现有存储源一致的定位能力：支持刷新当前目录列表、按应用现有排序选项排序（如名称/大小、升降序、目录优先），并支持在当前目录递归范围内按关键字搜索内容（仅返回匹配的可播放视频文件）。
- **FR-016**: 系统必须持久化 115 Open 的授权态（至少 `refresh_token`、可选缓存 `access_token` 与过期时间）到本地，并按 `storageKey` 做隔离；移除存储源时必须清理对应的授权态；在 UI 与日志中不得输出完整 token（仅允许遮罩/截断展示）。

### Acceptance Criteria (by requirement)

- **FR-001**: 在新增存储源入口中可选择“115 Open”，且新增成功后在存储列表中可见。
- **FR-002**: 添加/编辑页仅展示 token 输入项（无账号/密码输入）；用户可保存、取消，并在保存时对缺失字段给出明确提示。
- **FR-003**: 保存后能明确反馈“创建成功/失败”；失败时包含可理解原因，并提供“编辑 token/重试/取消”等入口。
- **FR-004**: 成功添加后默认可看到根目录文件列表；进入与返回目录后列表内容正确且可继续操作；列表可区分文件与目录并展示基础信息。
- **FR-005**: 点击受支持的视频文件可进入播放器并开始播放；点击不受支持文件会被拦截并提示原因。
- **FR-006**: 断网/弱网、文件不存在、授权失效等场景下，用户能看到明确提示与可执行的恢复操作入口。
- **FR-007**: 用户移除存储源后，该存储源从列表消失；再次进入不再显示该账号内容且需要重新添加才可恢复。
- **FR-008**: 可添加至少 2 个 115 Open 存储源；在不同存储源间切换时显示的数据互不混淆。
- **FR-009**: 授权失效时访问会被阻止并提示更新 token；更新成功后可继续浏览与播放。
- **FR-010**: 在 `access_token` 过期且 `refresh_token` 可用的情况下，用户无需手动更新 token 仍可继续浏览与播放；当自动恢复失败时才提示用户更新。
- **FR-011**: 115 Open 与百度网盘存储源共用同一套入口与页面结构：新增入口在同一处、存储源列表呈现方式一致、文件浏览页面结构一致、播放入口一致、管理/移除入口一致；不出现“仅 115 Open 可见”的独立流程。
- **FR-012**: 在配置页默认不展示完整 token（可采用遮罩/隐藏等方式），且在错误提示与日志中不输出完整 token；用户仍可更新 token。
- **FR-013**: 在设置中分别切换 Media3/Exo、mpv、VLC 作为播放内核：点击同一个受支持的视频文件均可进入播放器并开始播放；若某内核启动失败，应给出明确提示并允许用户切换到其他内核重试。
- **FR-014**: 保存 115 Open 存储源时会拉取并使用 `uid` 作为唯一标识；对同 `uid` 的重复添加会被拦截并提示用户改为编辑/更新既有存储源；本地持久化 URL 形如 `115open://uid/<uid>`。
- **FR-015**: 在 115 Open 文件列表页可执行刷新/排序/搜索；排序项与现有存储源一致；搜索可在当前目录递归范围内返回匹配的可播放视频文件，且清空搜索后恢复当前目录列表与上下文。
- **FR-016**: 关闭并重新打开应用后，已添加的 115 Open 存储源仍保持可用（在 token 未失效前可直接浏览/播放）；移除存储源后，本地不再保留该存储源的 token；任何错误提示与日志不包含完整 token。

### Key Entities *(include if feature involves data)*

- **115 Open 存储源**: 代表一个已添加的 115 Open 连接（展示名、账号唯一标识 `uid`、授权状态、`access_token`、`refresh_token`、过期时间、最近一次成功访问时间；本地唯一 URL 为 `115open://uid/<uid>`；授权态本地持久化并按 `storageKey` 隔离）。
- **115 文件项**: 代表一个目录或文件（名称、类型、路径/层级位置、可选的大小与修改时间）。
- **播放请求**: 代表一次从 115 文件启动播放的行为（目标文件、发起时间、结果状态、失败原因）。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 在用户已准备好 token 的前提下，新用户从“新增存储源”开始，到完成添加并看到 115 文件列表的流程，90% 的情况下可在 1 分钟内完成。
- **SC-002**: 在网络可用且授权有效的前提下，用户打开已添加的 115 存储源后，90% 的情况下可在 3 秒内看到首屏文件列表。
- **SC-003**: 在授权有效且网络可用的前提下，用户首次尝试从 115 播放受支持视频的成功率达到 90% 以上。
- **SC-004**: 当授权失效或网络不可用时，用户能够通过提示完成“重试/编辑 token/返回”的恢复操作，且无需强退应用即可继续使用其他功能（崩溃率 ≤ 0.5%）。
