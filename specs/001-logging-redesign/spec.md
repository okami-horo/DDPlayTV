# Feature Specification: 日志系统重构与治理

**Feature Branch**: `001-logging-redesign`  
**Created**: 2025-12-05  
**Status**: Draft  
**Input**: User description: "对当前项目的log日志功能设计进行重新设计，优化。目前的log存在Tag 与级别不可控、开关分裂、采集与上传耦合、噪声过多、I/O 频繁、结构化缺失等问题"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 统一可控的日志开关 (Priority: P1)

作为负责客户端开发和排查问题的工程师，我希望整个应用的日志有统一的全局级别和开关，并且可以通过统一入口快速调整全局日志级别，这样在调试某个问题时不会被无关日志淹没，可以在几分钟内定位到问题根因。

**Why this priority**: 当前日志 Tag 和级别不可控、开关分散，导致排查复杂问题时需要大量时间筛选噪声，是直接影响研发效率和线上问题响应速度的痛点。

**Independent Test**: 仅实现统一日志配置和开关，而不改动上传或结构化能力时，即可通过「调整全局日志级别」来独立验证，是否能在限定时间内定位到典型问题。

**Acceptance Scenarios**:

1. **Given** 应用为调试或测试构建，默认启用统一日志配置入口，**When** 用户将全局日志级别调整为“仅警告及以上”，**Then** 后续应用产生的日志只包含警告、错误等高优先级信息。
2. **Given** 应用为日常使用的发布构建且默认仅输出少量关键日志，**When** 任意用户通过统一日志配置入口临时打开全局调试日志（例如将全局级别调整为 DEBUG 并启用调试日志写入），**Then** 只在本次会话内额外输出 DEBUG 级别日志，且关闭应用或恢复默认配置后回到默认策略。

---

### User Story 2 - 高信噪比的诊断日志 (Priority: P2)

作为一线支持 / 测试 / 运营人员，我希望收集到的日志是高信噪比的，能够按时间、模块、严重程度快速过滤，并看到关键上下文字段，而不是长篇无结构文本，这样在复现和分析用户问题时可以更快给出结论。

**Why this priority**: 噪声过多和结构化缺失会直接降低日志的可读性，增加沟通成本，甚至导致无法从日志中确认问题，这影响整体问题处理效率和质量。

**Independent Test**: 在不改变日志上传方案的前提下，仅依赖本地日志目录中的日志文件（例如 `log.txt` / `log_old.txt`），即可通过「同一问题案例，使用旧日志与新日志各分析一次」对比确认分析时间和可读性是否显著改善。

**Acceptance Scenarios**:

1. **Given** 用户在使用过程中遇到功能异常，**When** 支持人员指导用户或自行通过 adb / 文件管理器从本地日志目录获取当前设备上的 `log.txt` / `log_old.txt` 等日志文件并进行查看，**Then** 日志可以按时间顺序呈现，包含清晰的模块标签、级别和关键上下文字段，且无大量重复或无意义的调试输出。
2. **Given** 支持人员根据日志文件中的模块标签和关键字进行搜索，**When** 过滤到与该问题相关的少量日志行，**Then** 可以在 10 分钟内拼接出完整问题链路（关键操作、异常点、恢复情况）。

---

### User Story 3 - 低开销的日志采集与导出 (Priority: P3)

作为产品负责人，我希望日志系统在保证诊断能力的前提下，对性能和存储空间的影响可控，即使在调试模式下开启较多日志，也不会让用户感知到明显卡顿或占用过多存储。

**Why this priority**: 当前 I/O 频繁可能带来性能风险，特别是在滚动、播放等对流畅度要求高的场景；同时在需要开启调试日志时，如果日志长时间持续写入且缺乏控制，也可能挤占用户存储，增加卸载风险。

**Independent Test**: 在开启「高日志量」策略的实验构建中，通过性能和额外空间占用对比测试，可以独立验证是否满足预期（如启动耗时、关键交互操作的卡顿率、日志文件大小的增长情况等）。

**Acceptance Scenarios**:

1. **Given** 应用使用带有高日志量策略的调试构建，**When** 用户连续使用核心功能 30 分钟（包括列表滚动、播放等高频操作），**Then** 不出现肉眼可感知的卡顿，首次启动耗时相较关闭日志的基线增加不超过 5%。 
2. **Given** 常规用户在默认日志策略下正常使用应用 7 天且未开启调试日志，**When** 检查本地存储空间，**Then** 不存在由日志系统产生的本地持久化日志文件，不会无感知占用额外存储。

### Edge Cases

- 在设备存储空间不足或连续写入失败时，日志系统应立即停止后续本地日志文件写入（包括 `log.txt` / `log_old.txt` 等），以避免因日志 I/O 导致应用崩溃或明显影响核心功能；必要时仍可保留 logcat 等瞬时通道输出。
- 本项目假定为单机本地使用场景，不存在多用户或多入口并发修改日志策略的情况，因此无需处理「多个入口在短时间内多次修改策略」的冲突合并问题。
- 在导出日志用于问题排查时，客户端不负责为用户提供导出入口或复杂的时间范围 / 内容裁剪逻辑；开发者或支持人员可以直接在本地日志目录中获取并打包当前设备上的 `log.txt` / `log_old.txt` 等文件，后续在分析阶段自行根据需要截取时间窗口、筛选内容和处理潜在敏感信息。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: System MUST 提供统一的日志配置入口，用于配置全局最小日志级别和调试日志写入开关（是否写入本地日志文件），并提供一份可配置的默认日志策略。
- **FR-002**: System MUST 规范化日志的模块标签和级别，所有新产生的日志必须归属于预定义的模块集合和有限的日志级别集合，避免自由文本 Tag 或自定义级别导致过滤和统计失效。
- **FR-003**: Users (所有使用应用的人) MUST be able to 在运行中的应用里查看当前日志策略，并通过对所有用户开放的统一日志配置入口安全地调整全局日志级别和调试日志写入开关，而无需重新安装或重启应用。
- **FR-004**: System MUST 将日志的产生与后续的导出解耦，任何导出过程的失败或取消都不影响本地日志的采集、过滤和查看。
- **FR-005**: System MUST 支持控制日志噪声，包括但不限于：设置默认最小输出级别、为部分高频日志设置采样 / 限流规则、允许对明显无价值的日志进行统一下线或禁用。
- **FR-006**: System MUST 为每条日志记录关键结构化字段（例如时间、模块、级别、业务场景、可选的会话 / 请求 ID 等），并保证在本地查看和导出时，这些字段保持可被解析和筛选的结构化形态，而不是单一长文本。
- **FR-007**: Users MUST be able to 方便地从本地日志目录获取用于诊断的一份「日志包」（例如包含当前设备上的 `log.txt` / `log_old.txt` 等本地日志文件以及必要的元信息）；System 不需要在应用内提供导出入口或复杂的裁剪界面，时间窗口和内容筛选可由开发者或支持人员在分析阶段离线完成。
- **FR-008**: System MUST 控制日志写入对性能的影响，包括采用合适的写入节奏和容量控制策略；在性能压力较大时，系统应优先保证核心功能流畅性，即在必要时丢弃低优先级日志，而不是阻塞关键交互。
- **FR-011**: 本开源项目中的日志仅用于本地调试与问题排查，System MUST 不包含任何线上日志或远程上传实现；本规范不对日志内容中是否包含敏感字段做额外约束，由具体使用者在实际使用场景下自行评估和控制。
- **FR-012**: System MUST 提供统一的日志记录入口（Logger 门面），所有模块和组件只能通过该入口输出日志；禁止直接调用 Android 平台的 `Log.*` 或自行引入新的日志库绕过统一日志系统，历史多套日志实现需要在本次重构中收敛到该入口。
- **FR-013**: System MUST 定义统一的日志级别集合（至少包含 DEBUG / INFO / WARN / ERROR），并在默认策略下仅输出 INFO、ERROR 两个级别的日志；DEBUG 级别日志默认不输出，只有当用户在统一日志配置入口中显式开启“调试日志”或等效开关时，才会输出 DEBUG 日志（其他级别的默认策略可在配置中扩展，但不得破坏此默认约束）。
- **FR-014**: System MUST 在未开启 DEBUG 日志级别输出时，不将任何日志写入本地持久化文件，仅输出到 logcat 等瞬时通道；当用户在统一日志配置入口中开启“调试日志”开关后，才开始将符合当前策略的日志写入本地文件，关闭开关后应立即停止写入。
- **FR-015**: System MUST 对本地日志文件采用固定的双文件轮转策略，仅允许存在 `log.txt` 和 `log_old.txt`：其中 `log.txt` 始终表示当前（最近一次应用运行会话）的日志文件，`log_old.txt` 表示上一运行会话的历史日志；在应用冷启动时，如果检测到已有 `log.txt`，应将其内容移动或追加到 `log_old.txt`（必要时可进行简单裁剪），随后清空或重建 `log.txt` 用于记录本次会话日志，不再创建额外的本地日志文件。
- **FR-016**: 当检测到设备存储空间不足或连续写入失败时，System MUST 立即停止后续本地日志文件写入操作（包括 `log.txt` / `log_old.txt` 等），以避免因日志 I/O 导致应用崩溃或阻塞核心功能；在条件允许的情况下，可以继续通过 logcat 等瞬时通道输出日志。

### Key Entities *(include if feature involves data)*

- **Log Event（日志事件）**: 表示一次具体的日志记录，包含时间、模块标签、级别、消息文本、结构化字段（业务场景、会话 / 请求 ID、错误码等），用于还原某个操作或异常的上下文。
- **Log Policy（日志策略）**: 表示一组日志输出规则，包括全局默认级别、调试日志写入开关、采样 / 限流配置以及是否允许导出，用于驱动运行时的日志行为。
- **Log Package（日志包 / 采集快照）**: 表示为一次问题排查或用户反馈生成的日志集合，包含一段时间内的日志事件和必要的环境元信息，用于在内部共享和分析。

## Assumptions

- 本规范聚焦于客户端日志体系的设计和治理，不包含服务端日志平台或分析系统的实现细节，仅要求预留对接能力。
- 默认假设仅在显式开启「调试日志」时才会写入本地日志文件，且本规范不对日志文件总大小和保留时间做强约束；如有需要，可由操作者在调试完成后手动导出或清理。
- 默认假设本开源项目中日志开关入口对所有使用应用的用户开放，所有人都可以使用统一的日志配置能力进行开发和问题诊断；本规范不区分用户角色，也不约束未来可能出现的差异化发行版。
- 默认假设日志内容完全由使用本项目的开发者 / 操作者自行控制，本规范不对是否记录账号、标识符等敏感字段做约束；由于本项目不提供任何线上日志或远程上传能力，日志仅保存在本地，由使用者自行承担内容管理责任。
- 默认假设同一时间内仅有单一操作者在本地设备上修改日志配置，不存在多用户或多入口并发修改策略的情况，因此无需额外的冲突合并或抢占规则。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 在典型调试场景下，开发者仅通过新的日志配置和查看能力，在 10 分钟内完成 90% 以上已知问题案例的根因定位，相比改造前至少缩短 30% 的排查时间（以内部试验任务统计为准）。
- **SC-002**: 在默认日志策略下，与完全关闭日志的基线版本相比，应用冷启动耗时增加不超过 5%，关键交互（如滚动列表、播放操作）的卡顿率无统计学显著差异（以性能实验对比为准）。
- **SC-003**: 在默认日志策略下，用户持续使用应用 7 天且未开启调试日志时，单个用户设备上不会生成本地持久化日志文件，不会对存储空间产生额外占用。
- **SC-004**: 针对同一批问题样本（来自真实用户反馈或内部测试），使用新日志体系导出的日志包进行分析时，支持 / 测试人员判定为「无效或重复噪声」的日志行占总行数的比例，相比改造前至少降低 50%，并且至少 80% 的问题可以通过单份日志包完成闭环而无需额外补采。

### 验证路径

- **SC-001**：使用 User Story 1 的统一开关与级别调整，在内部典型案例集上对比改造前后定位耗时，并记录 90% 闭环率与 30% 耗时缩短的实验数据。
- **SC-002**：在默认策略与完全关闭日志的构建上跑冷启动与核心交互性能实验，对比启动耗时与卡顿率，确认增量不超过 5% 且无统计显著差异。
- **SC-003**：以默认策略、未开启调试日志的日常使用场景跑 7 天留存实验，检查日志目录确保不存在 `log.txt` / `log_old.txt` 等持久化文件。
- **SC-004**：对同一批问题样本生成日志包并进行人工分析，统计无效/重复噪声比例与单份日志包闭环率，验证噪声占比降低至少 50%、闭环率达到 80%。

## Clarifications

### Session 2025-12-05

- Q: 本次特性是否交付任何线上日志或远程上传能力？ → A: 否。本次仅重构本地日志体系（采集、配置、查看与导出），不交付也不设计任何线上日志或远程上传能力；如未来需要远程日志，将通过独立规范进行设计。
- Q: 日志开关对哪些用户开放、通过什么入口暴露？ → A: 在本开源项目中，不区分用户角色，对所有使用应用的用户开放统一的日志配置入口。
