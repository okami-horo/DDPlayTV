name: package beta

# develop åˆ†æ”¯æäº¤ä»£ç æ—¶ï¼Œæ„å»ºæœ€æ–°æµ‹è¯•åŒ…
on:
  push:
    branches:
      - develop
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  package:
    name: Generate Beta APK
    runs-on: ubuntu-latest
    steps:
      # 1.æ‹‰å–ä»£ç 
      - name: checkout source code
        uses: actions/checkout@v4

      # 2.é…ç½®JDK
      - name: set up JDK for sdkmanager
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: adopt
      - name: install Android 35 SDK
        run: |
          set -euo pipefail
          SDKMANAGER="$(command -v sdkmanager || true)"
          if [[ -z "$SDKMANAGER" ]]; then
            SDKMANAGER="${ANDROID_HOME:-${ANDROID_SDK_ROOT:-}}/cmdline-tools/latest/bin/sdkmanager"
          fi
          if [[ ! -x "$SDKMANAGER" ]]; then
            echo "sdkmanager not found" >&2
            exit 1
          fi
          if ! yes | "$SDKMANAGER" --licenses > /dev/null; then
            status=${PIPESTATUS[1]}
            if [[ ${status:-1} -ne 0 ]]; then
              exit "$status"
            fi
          fi
          if ! yes | "$SDKMANAGER" "platforms;android-35" "build-tools;35.0.0"; then
            status=${PIPESTATUS[1]}
            if [[ ${status:-1} -ne 0 ]]; then
              exit "$status"
            fi
          fi

      - name: ensure JDK 17 for Gradle
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: adopt

      # 3.æ³¨å…¥å¯†é’¥åˆ°ç¯å¢ƒå˜é‡
      - name: inject secrets to environment  
        env:
          BUGLY_APP_ID: ${{ secrets.BUGLY_APP_ID }}
          DANDAN_APP_ID: ${{ secrets.DANDAN_APP_ID }}
          DANDAN_APP_SECRET: ${{ secrets.DANDAN_APP_SECRET }}
          BAIDU_PAN_CLIENT_ID: ${{ secrets.BAIDU_PAN_CLIENT_ID }}
          BAIDU_PAN_CLIENT_SECRET: ${{ secrets.BAIDU_PAN_CLIENT_SECRET }}
          ALIYUN_SECRET: ${{ secrets.ALIYUN_SECRET }}
        run: |
          echo "âœ… Secrets injected for beta build"
          echo "BUGLY_APP_ID length: ${#BUGLY_APP_ID}"

      # 4.è·å–ç­¾åå¯†é’¥
      - name: decrypt key
        run: |
          gpg --quiet --batch --yes --decrypt \
          --passphrase=${{ secrets.KEY_PASSPHRASE }} \
          --output gradle/assemble/dandanplay.jks gradle/assemble/dandanplay.jks.gpg

      # 4.é…ç½®æ„å»ºç±»å‹
      - name: setup build type
        run: echo "BUILD_TYPE=beta" >> $GITHUB_ENV

      # 5.è·å–åˆ†æ”¯åç§°
      - name: get branch name
        run: |
          # æå–åˆ†æ”¯åï¼Œç§»é™¤ refs/heads/ å‰ç¼€
          branch_name=${GITHUB_REF#refs/heads/}
          # å°†ç‰¹æ®Šå­—ç¬¦æ›¿æ¢ä¸º - ï¼Œç¡®ä¿tagåç§°æœ‰æ•ˆ
          safe_branch_name=$(echo "$branch_name" | sed 's/[^a-zA-Z0-9._-]/-/g')
          echo "BRANCH_NAME=$safe_branch_name" >> $GITHUB_ENV
          echo "åŸå§‹åˆ†æ”¯å: $branch_name"
          echo "å®‰å…¨åˆ†æ”¯å: $safe_branch_name"

      # 6.æ„å»ºå®‰è£…åŒ…
      - name: assemble apk
        env:
          # ç­¾åç›¸å…³å¯†é’¥
          KEYSTORE_PASS: ${{ secrets.KEYSTORE_PASS }}
          ALIAS_NAME: ${{ secrets.ALIAS_NAME }}
          ALIAS_PASS: ${{ secrets.ALIAS_PASS }}
          # åº”ç”¨å¯†é’¥ - ä»Secretsæ³¨å…¥
          BUGLY_APP_ID: ${{ secrets.BUGLY_APP_ID }}
          DANDAN_APP_ID: ${{ secrets.DANDAN_APP_ID }}
          DANDAN_APP_SECRET: ${{ secrets.DANDAN_APP_SECRET }}
          BAIDU_PAN_CLIENT_ID: ${{ secrets.BAIDU_PAN_CLIENT_ID }}
          BAIDU_PAN_CLIENT_SECRET: ${{ secrets.BAIDU_PAN_CLIENT_SECRET }}
          ALIYUN_SECRET: ${{ secrets.ALIYUN_SECRET }}
        run: chmod +x gradlew &&./gradlew clean assemble${{ env.BUILD_TYPE }} --stacktrace

      # 6.é…ç½®æ„å»ºç‰ˆæœ¬
      - name: setup build version
        run: |
          apk_version=$(grep -oP 'versionName\s*=\s*"\K[^"]+' buildSrc/src/main/java/Versions.kt | head -n1)
          echo "BUILD_VERSION=$apk_version" >> "$GITHUB_ENV"

      # 7.ç§»åŠ¨æ–‡ä»¶åˆ°æ ¹ç›®å½•
      - name: move file
        run: |
          abis=(arm64-v8a armeabi-v7a universal)
          for abi in ${abis[@]}
          do
            # åŸæ–‡ä»¶å
            original_name="ddplaytv_v${{ env.BUILD_VERSION }}_${abi}-${{ env.BUILD_TYPE }}.apk"
            # æ–°æ–‡ä»¶åï¼ˆåŒ…å«åˆ†æ”¯ä¿¡æ¯ï¼‰
            new_name="ddplaytv_v${{ env.BUILD_VERSION }}_${abi}-${{ env.BUILD_TYPE }}-${{ env.BRANCH_NAME }}.apk"
            mv app/build/outputs/apk/${{ env.BUILD_TYPE }}/${original_name} ${new_name}
          done

      # 8.åˆ›å»ºRelease
      - name: generate release
        id: generate_release
        uses: softprops/action-gh-release@v1
        with:
          name: å¼¹å¼¹playæ¦‚å¿µç‰ˆ v${{ env.BUILD_VERSION }} Beta (${{ env.BRANCH_NAME }})
          tag_name: dandanplay-v${{ env.BUILD_VERSION }}-beta-${{ env.BRANCH_NAME }}
          body: |
            ğŸš€ æœ€æ–°æµ‹è¯•åŒ… - åˆ†æ”¯: ${{ env.BRANCH_NAME }}
            ğŸ“… æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
            ğŸ“ æœ€æ–°æäº¤: ${{ github.event.head_commit.message }}
            ğŸ‘¤ æäº¤è€…: ${{ github.event.head_commit.author.name }}
          prerelease: true
          files: |
            ddplaytv_v${{ env.BUILD_VERSION }}_arm64-v8a-${{ env.BUILD_TYPE }}-${{ env.BRANCH_NAME }}.apk
            ddplaytv_v${{ env.BUILD_VERSION }}_armeabi-v7a-${{ env.BUILD_TYPE }}-${{ env.BRANCH_NAME }}.apk
            ddplaytv_v${{ env.BUILD_VERSION }}_universal-${{ env.BUILD_TYPE }}-${{ env.BRANCH_NAME }}.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
